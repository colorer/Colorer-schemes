   0: <span class='perl-Comment def-Comment def-Syntax'># Copyright (C) 2000 Mark Stosberg </span><span class='def-String'>&lt;</span><span class='def-EMail def-URI'>mark@stosberg.com</span><span class='def-String'>></span>
   1: <span class='perl-Comment def-Comment def-Syntax'># Licensed under the the GNU GPL, available here: </span><span class='def-URL def-URI'>http://www.gnu.org/copyleft/gpl.html</span>
   2: 
   3: <span class='perl-Comment def-Comment def-Syntax'># Originally by Mark Stosberg </span><span class='def-EMail def-URI'>mark@summersault.com</span><span class='perl-Comment def-Comment def-Syntax'> for the skatepark.org website</span>
   4: <span class='perl-Comment def-Comment def-Syntax'># inspired by sumsearch by Chris Hardie </span><span class='def-String'>&lt;</span><span class='def-EMail def-URI'>chris@summersault.com</span><span class='def-String'>></span>
   5: 
   6: <span class='perl-PodSym def-Symbol'>=pod</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
   7: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
   8: <span class='perl-PodSym def-Symbol'>=head1</span><span class='perl-PodText'> NAME</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
   9: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  10: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Cascade - Content Management System for a database driven web based dir</span>
  11: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  12: <span class='perl-PodSym def-Symbol'>=head1</span><span class='perl-PodText'> SYNOPSIS</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  13: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  14: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Cascade is expected to be used by an instance script, </span>
  15: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>which provides loads a configuration file and runs</span>
  16: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>the web application. See </span><span class='perl-PodSel def-Label'>C&lt;html_path/cgi-bin/cascade.cgi></span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  17: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>included in the distribution for a working example. You</span>
  18: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>may be able use this directly, only changing </span>
  19: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>the configuration file to make it work for you. An</span>
  20: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>example configuration file is provided in the distribution</span>
  21: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>at </span><span class='perl-PodSel def-Label'>C&lt;config/config.pl></span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>.</span>
  22: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  23: <span class='perl-PodSym def-Symbol'>=head1</span><span class='perl-PodText'> DESCRIPTION </span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  24: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  25: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Cascade is a content management application for a database-driven</span>
  26: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>web-based directory. Since it's primarily intended to be used as an</span>
  27: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>application rather than directly as Perl modules, most of the</span>
  28: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>documention here of how the module works won't be interesting to most</span>
  29: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>users. Instead, read the INSTALL file in the distribution to get your</span>
  30: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>site up and running. The remaining documentation in the Cascade</span>
  31: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>modules for is provided for hackers who might want to tinker with the</span>
  32: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>code, and for myself, so I can remember why I did the things I did. </span>
  33: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  34: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>For a detailed description of Cascade, see:</span>
  35: <span class='def-URL def-URI'>http://summersault.com/software/cascade</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> </span>
  36: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  37: <span class='perl-PodSym def-Symbol'>=head1</span><span class='perl-PodText'> AUTHOR</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  38: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  39: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Copyright (C) 2000-2001 Mark Stosberg </span><span class='def-String'>&lt;</span><span class='def-EMail def-URI'>mark@stosberg.com</span><span class='def-String'>></span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  40: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  41: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>This library is free software; you can redistribute it and/or modify</span>
  42: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  43: <span class='def-Error'> </span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  44: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Address bug reports and comments to: </span><span class='def-EMail def-URI'>mark@stosberg.com.</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>  When sending</span>
  45: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>bug reports, please provide the version of Cascade, the version of</span>
  46: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>Perl, the name and version of your Web server, the name and version of</span>
  47: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>the operating system you are using, and the name and version of the</span>
  48: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>database you are using.  If the problem is even remotely browser</span>
  49: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>dependent, please provide information about the affected browers as</span>
  50: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>well.</span>
  51: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  52: <span class='perl-PodSym def-Symbol'>=head1</span><span class='perl-PodText'> SEE ALSO</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  53: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  54: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>perl(1).</span>
  55: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  56: <span class='perl-PodSym def-Symbol'>=head2</span><span class='perl-PodText'> Steps for adding a new run mode</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  57: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  58: <span class='perl-PodSym def-Symbol'>=over </span><span class='perl-Numb def-Number'>4</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  59: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  60: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * Add entry in run_modes() hash in &amp;Cascade::setup</span>
  61: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  62: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * If run mode is non-public, create an appropriate entry in the</span>
  63: <span class='perl-PodExample def-String'>        RM_AUTH hash in config/config.pl</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  64: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  65: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * Add run mode to appropriate module. Right now this</span>
  66: <span class='perl-PodExample def-String'>     Cascade::Admin for editor and admin run modes, and Cascade.pm</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  67: <span class='perl-PodExample def-String'>     for most everything else. </span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  68: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  69: <span class='perl-PodSym def-Symbol'>=back</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  70: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  71: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>See the documentation for CGI::Application for further information on</span>
  72: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>run modes.</span>
  73: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
  74: <span class='perl-PodSym def-Symbol'>=cut</span>
  75: 
  76: <span class='perl-Word def-Keyword'>package</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
  77: <span class='perl-Comment def-Comment def-Syntax'># CGI::Application will "use CGI" for us, but it doesn't check the version, </span>
  78: <span class='perl-Comment def-Comment def-Syntax'># so we do that here. In earlier versions, "Vars" may not work as we'd like or expect. -mls</span>
  79: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>CGI</span> <span class='perl-Numb def-Number'>2.</span><span class='perl-Numb def-Number'>75</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
  80: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages-pragmas perl-Word def-Keyword'>base</span> <span class='perl-String def-String'>'CGI::Application'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
  81: 
  82: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBI</span> <span class='perl-Numb def-Number'>1.</span><span class='perl-Numb def-Number'>20</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Comment def-Comment def-Syntax'># we depened on some features added in this version </span>
  83: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>CGI::Carp</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
  84: 
  85: <span class='perl-Comment def-Comment def-Syntax'># Global variables</span>
  86: <span class='perl-Comment def-Comment def-Syntax'># %TMPL is a global hash to for template handle recycling</span>
  87: <span class='perl-Comment def-Comment def-Syntax'>#   the keys are filenames and the values are handles for those files</span>
  88: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages-pragmas perl-Word def-Keyword'>vars</span> <span class='perl-ReType perl-Word def-Keyword'>qw </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>(</span><span class='perl-String def-String'></span>
  89: <span class='perl-String def-String'>    $DBH</span>
  90: <span class='perl-String def-String'>    $DEBUG</span>
  91: <span class='perl-String def-String'>    $VERSION  </span>
  92: <span class='perl-String def-String'>    %CFG</span>
  93: <span class='perl-String def-String'>    %FORM</span>
  94: <span class='perl-String def-String'>    %SES</span>
  95: <span class='perl-String def-String'>    %TMPL  </span>
  96: <span class='perl-String def-String'>    $q</span>
  97: <span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
  98: 
  99: <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Exporter</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 100: <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@ISA</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-ReType perl-Word def-Keyword'>qw</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>(</span><span class='perl-String def-String'>Exporter</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 101: 
 102: <span class='perl-Var def-Var'>@EXPORT_OK</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-ReType perl-Word def-Keyword'>qw</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>(</span><span class='perl-String def-String'></span>
 103: <span class='perl-String def-String'>  $DBH</span>
 104: <span class='perl-String def-String'>  $VERSION</span>
 105: <span class='perl-String def-String'>  %CFG</span>
 106: <span class='perl-String def-String'>  %FORM</span>
 107: <span class='perl-String def-String'>  %SES</span>
 108: <span class='perl-String def-String'>  %TMPL</span>
 109: <span class='perl-String def-String'>  &amp;_html_error</span>
 110: <span class='perl-String def-String'>  &amp;cat_already_exists</span>
 111: <span class='perl-String def-String'>  &amp;check_cat_url</span>
 112: <span class='perl-String def-String'>  &amp;conflicts_with_existing_cat</span>
 113: <span class='perl-String def-String'>  &amp;err</span>
 114: <span class='perl-String def-String'>  &amp;footer_html_tmpl</span>
 115: <span class='perl-String def-String'>  &amp;front_page</span>
 116: <span class='perl-String def-String'>  &amp;gettext</span>
 117: <span class='perl-String def-String'>  &amp;html_item_new</span>
 118: <span class='perl-String def-String'>  &amp;illegal_chars</span>
 119: <span class='perl-String def-String'>  &amp;is_role</span>
 120: <span class='perl-String def-String'>  &amp;validate_image</span>
 121: <span class='perl-String def-String'>  $q</span>
 122: <span class='perl-String def-String'>  &amp;htmlicize</span>
 123: <span class='perl-String def-String'>  &amp;insert_hash</span>
 124: <span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 125: 
 126: <span class='perl-Var def-Var'>@EXPORT</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@EXPORT_OK</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 127: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages-pragmas perl-Word def-Keyword'>strict</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 128: 
 129: <span class='perl-Word def-Keyword'>use</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Auth</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 130: <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Category</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 131: <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Item</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 132: 
 133: <span class='perl-Comment def-Comment def-Syntax'># XXX How can I avoid loading the admin module for every page? </span>
 134: <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Admin</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 135: <span class='perl-Var def-Var'>$VERSION</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'2.1.2'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 136: 
 137: <span class='perl-Comment def-Comment def-Syntax'># Internationalization stuff</span>
 138: <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>LAN</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>ne</span> <span class='perl-String def-String'>''</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>LAN</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>ne</span> <span class='perl-String def-String'>'en'</span> <span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span> 
 139:     <span class='perl-Comment def-Comment def-Syntax'># XXX very broken for now, because gettext is sparsely used. -mls</span>
 140:     <span class='perl-Comment def-Comment def-Syntax'># We require rather than 'use' POSIX here so it only get's loaded inside of this "if" block</span>
 141:     <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>POSIX</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 142:     import <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>POSIX</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 143:     <span class='perl-Word def-Keyword'>eval</span> <span class='perl-String def-String'>"use Locale::gettext"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 144:     <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>LC_MESSAGES</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>LAN</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 145:     bindtextdomain<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DATABASE</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CATDIR</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-Symbol'>)</span> <span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 146:     textdomain<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DATABASE</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 147:     <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>POSIX</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span>setlocale<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>POSIX</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>LC_MESSAGES</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>''</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 148: <span class='def-SymbolStrong def-Symbol'>}</span>
 149: <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 150:   <span class='perl-Comment def-Comment def-Syntax'># In case that we dont want to use gettext, this is  the shortcut</span>
 151:   <span class='perl-Var def-Var'>*gettext</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 152: <span class='def-SymbolStrong def-Symbol'>}</span>
 153: 
 154: <span class='perl-Word def-Keyword'>sub</span> setup <span class='def-SymbolStrong def-Symbol'>{</span>
 155:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 156:     <span class='perl-Var def-Var'>$DBH</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>=</span> connect_db<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>die</span> <span class='perl-String def-String'>"Could not connect to database. Check connection parameters"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 157: 
 158:     <span class='perl-Comment def-Comment def-Syntax'># Put param variables into a global hash</span>
 159:     <span class='perl-Var def-Var'>$q</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 160:     <span class='perl-Var def-Var'>%FORM</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>%FORM</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>Vars<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 161: 
 162: <span class='perl-Comment def-Comment def-Syntax'># set $FORM{rm} (run mode)</span>
 163:     <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'front_page'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 164:     <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>get_mode_param<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 165: 
 166:     <span class='perl-Var def-Var'>%SES</span> <span class='perl-Symb def-Symbol'>=</span> validate_session<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 167: <span class='perl-Comment def-Comment def-Syntax'>#  It would be nice to distinquish failures that occur when people are</span>
 168: <span class='perl-Comment def-Comment def-Syntax'>#  logged in, just not at a high enough level (ie, they are logged in</span>
 169: <span class='perl-Comment def-Comment def-Syntax'>#  as editor, but the run mode requires them to be an admin). This isn't the way to</span>
 170: <span class='perl-Comment def-Comment def-Syntax'>#  do it.</span>
 171: <span class='perl-Comment def-Comment def-Syntax'>#  $SES{valid_idle} or print</span>
 172: <span class='perl-Comment def-Comment def-Syntax'>#  CGI::header().err(title=>'Insufficient Authorization', msg=>'The</span>
 173: <span class='perl-Comment def-Comment def-Syntax'>#  user you logged in as does not have permission to view this page.')</span>
 174: <span class='perl-Comment def-Comment def-Syntax'>#  and exit;</span>
 175:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$start_mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>valid_idle</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-String def-String'>'login'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 176:     <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>start_mode<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$start_mode</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 177: 
 178:     <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>run_modes<span class='def-Symbol'>(</span>
 179:             <span class='perl-String def-String'>'front_page'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'front_page'</span><span class='perl-Symb def-Symbol'>,</span>
 180: <span class='perl-Comment def-Comment def-Syntax'># "cat" is just a short alias for "category_page"</span>
 181:             <span class='perl-String def-String'>'cat'</span>          <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'category_page'</span><span class='perl-Symb def-Symbol'>,</span>
 182:             <span class='perl-String def-String'>'category_page'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'category_page'</span><span class='perl-Symb def-Symbol'>,</span>
 183:             <span class='perl-String def-String'>'item_add_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_add_form'</span><span class='perl-Symb def-Symbol'>,</span>
 184:             <span class='perl-String def-String'>'item_suggest_add'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_suggest_add'</span><span class='perl-Symb def-Symbol'>,</span> 
 185:             <span class='perl-String def-String'>'item_approve_add'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_approve_add'</span><span class='perl-Symb def-Symbol'>,</span>
 186:             <span class='perl-Var def-Var'>item_approve_insert </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_approve_insert'</span><span class='perl-Symb def-Symbol'>,</span>
 187:             <span class='perl-Var def-Var'>item_approve_update </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_approve_update'</span><span class='perl-Symb def-Symbol'>,</span>
 188:             <span class='perl-String def-String'>'item_edit_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_edit_form'</span><span class='perl-Symb def-Symbol'>,</span>
 189:             <span class='perl-String def-String'>'item_delete_checklist'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_delete_checklist'</span><span class='perl-Symb def-Symbol'>,</span>
 190:             <span class='perl-String def-String'>'item_list_delete_urls'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_list_delete_urls'</span><span class='perl-Symb def-Symbol'>,</span>
 191: <span class='perl-Comment def-Comment def-Syntax'># we make this alias so we can force editors to login when they visit urls via email to edit suggestions -mls</span>
 192:             <span class='perl-Var def-Var'>item_edit_suggestion_form </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_edit_form'</span><span class='perl-Symb def-Symbol'>,</span>
 193:             <span class='perl-String def-String'>'item_new'</span>    <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'html_item_new'</span><span class='perl-Symb def-Symbol'>,</span>
 194:             <span class='perl-String def-String'>'write_static_pages'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'write_static_pages'</span><span class='perl-Symb def-Symbol'>,</span>
 195:             <span class='perl-String def-String'>'item_suggest_update'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_suggest_update'</span><span class='perl-Symb def-Symbol'>,</span>
 196:             <span class='perl-String def-String'>'cat_add_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_add_form'</span><span class='perl-Symb def-Symbol'>,</span>
 197:             <span class='perl-String def-String'>'cat_add_process'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_add_process'</span><span class='perl-Symb def-Symbol'>,</span>
 198:             <span class='perl-String def-String'>'link_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'link_form'</span><span class='perl-Symb def-Symbol'>,</span>
 199:             <span class='perl-String def-String'>'link_add'</span>  <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'link_add'</span><span class='perl-Symb def-Symbol'>,</span>
 200:             <span class='perl-String def-String'>'link_edit'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'link_edit'</span><span class='perl-Symb def-Symbol'>,</span>
 201:             <span class='perl-String def-String'>'link_delete'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'link_delete'</span><span class='perl-Symb def-Symbol'>,</span>
 202:             <span class='perl-String def-String'>'cat_relate_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_relate_form'</span><span class='perl-Symb def-Symbol'>,</span>
 203:             <span class='perl-String def-String'>'cat_relate_update'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_relate_update'</span><span class='perl-Symb def-Symbol'>,</span>
 204:             <span class='perl-String def-String'>'cat_edit_form'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_edit_form'</span><span class='perl-Symb def-Symbol'>,</span>
 205:             <span class='perl-String def-String'>'cat_update'</span>    <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_update'</span><span class='perl-Symb def-Symbol'>,</span>
 206:             <span class='perl-String def-String'>'cat_delete'</span>    <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'cat_delete'</span><span class='perl-Symb def-Symbol'>,</span>
 207:             <span class='perl-String def-String'>'item_delete'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'item_delete'</span><span class='perl-Symb def-Symbol'>,</span>
 208:             <span class='perl-String def-String'>'needs_approval_summary'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'needs_approval_summary'</span><span class='perl-Symb def-Symbol'>,</span>
 209:             <span class='perl-String def-String'>'unverified_urls_report'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-String def-String'>'unverified_urls_report'</span><span class='perl-Symb def-Symbol'>,</span>
 210:             <span class='perl-Var def-Var'>search_zip    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'search_zip'</span><span class='perl-Symb def-Symbol'>,</span>
 211:             <span class='perl-Var def-Var'>item_edit </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_edit'</span><span class='perl-Symb def-Symbol'>,</span>
 212:             <span class='perl-Var def-Var'>item_suggest_update_form </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_suggest_update_form'</span><span class='perl-Symb def-Symbol'>,</span>
 213:             <span class='perl-Var def-Var'>item_suggest_update_thanks </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_suggest_update_thanks'</span><span class='perl-Symb def-Symbol'>,</span>
 214:             <span class='perl-Var def-Var'>login    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'login_form'</span><span class='perl-Symb def-Symbol'>,</span>
 215:             <span class='perl-Var def-Var'>login_process </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'login_process'</span><span class='perl-Symb def-Symbol'>,</span>
 216:             <span class='perl-Var def-Var'>logout    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'logout'</span><span class='perl-Symb def-Symbol'>,</span>
 217:             <span class='perl-Var def-Var'>register_form </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'register_form'</span><span class='perl-Symb def-Symbol'>,</span>
 218:             <span class='perl-Var def-Var'>register_process </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'register_process'</span><span class='perl-Symb def-Symbol'>,</span>
 219:             <span class='perl-Var def-Var'>password_forgot_form </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'password_forgot_form'</span><span class='perl-Symb def-Symbol'>,</span>
 220:             <span class='perl-Var def-Var'>password_mail_forgotten </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'password_mail_forgotten'</span><span class='perl-Symb def-Symbol'>,</span>
 221:             <span class='perl-Var def-Var'>password_mail_success </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'password_mail_success'</span><span class='perl-Symb def-Symbol'>,</span>
 222:             <span class='perl-Var def-Var'>item_view_comments </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_view_comments'</span><span class='perl-Symb def-Symbol'>,</span>
 223:             <span class='perl-Var def-Var'>item_comment_post  </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_comment_post'</span><span class='perl-Symb def-Symbol'>,</span>
 224:             <span class='perl-Var def-Var'>item_comments_delete </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_comments_delete'</span><span class='perl-Symb def-Symbol'>,</span>
 225:             <span class='perl-Var def-Var'>item_include_comments </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'item_include_comments'</span><span class='perl-Symb def-Symbol'>,</span>
 226:             <span class='perl-Var def-Var'>pvt_basic_info_update_form </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>User</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Symb def-Symbol'>&amp;</span>pvt_basic_info_update_form <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> 
 227:             <span class='perl-Var def-Var'>pvt_home </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>User</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Symb def-Symbol'>&amp;</span>pvt_home <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> 
 228:             <span class='perl-Var def-Var'>shared_home </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>User</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Symb def-Symbol'>&amp;</span>shared_home <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> 
 229:             <span class='perl-Var def-Var'>pvt_basic_info_process </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>User</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Symb def-Symbol'>&amp;</span>pvt_basic_info_process <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> 
 230:             <span class='perl-Var def-Var'>current_contributors </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>User</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Symb def-Symbol'>&amp;</span>current_contributors <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> 
 231:             <span class='perl-Var def-Var'>historical_month_index </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'historical_month_index'</span><span class='perl-Symb def-Symbol'>,</span> 
 232:             <span class='perl-Var def-Var'>historical_all_index </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'historical_all_index'</span><span class='perl-Symb def-Symbol'>,</span> 
 233:             <span class='perl-Var def-Var'>AUTOLOAD           </span><span class='perl-Symb def-Symbol'>=></span> 
 234:                 <span class='perl-Word def-Keyword'>sub</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Page not found'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"(the run mode tried was: </span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>)"</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>}</span>
 235:             <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 236: 
 237: <span class='perl-Comment def-Comment def-Syntax'># This happens here so that we can declare $VERSION in Cascade.pm to make CPAN happy</span>
 238: <span class='perl-Comment def-Comment def-Syntax'># but also have a copy in %CFG to make template management easier. -mls</span>
 239:             <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>VERSION</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$VERSION</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 240: <span class='def-SymbolStrong def-Symbol'>}</span>
 241: 
 242: <span class='perl-Comment def-Comment def-Syntax'># use the first piece of PATH_INFO, or just look in $FORM{rm};</span>
 243: <span class='perl-Word def-Keyword'>sub</span> get_mode_param <span class='def-SymbolStrong def-Symbol'>{</span>
 244:    <span class='perl-Comment def-Comment def-Syntax'># The run mode is the first chunk, the rest goes back into PATH_INFO</span>
 245:    <span class='perl-Comment def-Comment def-Syntax'># We ignore any leading slashes</span>
 246:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$pi</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 247:    <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$pi</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>PATH_INFO</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>PATH_INFO</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>@</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-String def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>[</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-String def-String'>/</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>]</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='perl-String def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-MetaSymb def-Symbol'>.</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>@</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 248: 
 249:   <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$pi</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Var def-Var'>$pi</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 250: <span class='def-SymbolStrong def-Symbol'>}</span>
 251: 
 252: <span class='perl-PodSym def-Symbol'>=pod</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> </span>
 253: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 254: <span class='perl-PodSym def-Symbol'>=head2</span><span class='perl-PodText'> A note about template namespaces</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 255: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 256: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'>A few prefixes in the template namespace are reserved for use by Cascade. These include:</span>
 257: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 258: <span class='perl-PodSym def-Symbol'>=over </span><span class='perl-Numb def-Number'>4</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 259: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 260: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * cfg_ -- variables from the CFG hash</span>
 261: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 262: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * ses_ -- session variables</span>
 263: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 264: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * err_ -- error variables</span>
 265: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 266: <span class='perl-PodSym def-Symbol'>=item</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'> * role_ -- role variables </span>
 267: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 268: <span class='perl-PodSym def-Symbol'>=back</span><span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 269: <span class='perl-Pod def-CommentDoc def-Comment def-Syntax'></span>
 270: <span class='perl-PodSym def-Symbol'>=cut</span>
 271: 
 272: <span class='perl-Word def-Keyword'>sub</span> load_tmpl <span class='def-SymbolStrong def-Symbol'>{</span>
 273:         <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 274:         <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$tmpl_file</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@extra_params</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 275:  
 276:         <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$fq_tmpl_file</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>tmpl_path<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>.</span> <span class='perl-Var def-Var'>$tmpl_file</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 277:  
 278:         <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Template</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 279:     <span class='perl-Comment def-Comment def-Syntax'># set up the templates with some defaults</span>
 280:         <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Template</span><span class='perl-Symb def-Symbol'>-></span>new_file<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$fq_tmpl_file</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@extra_params</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>%</span><span class='perl-Var def-Var'>{</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTML_TMPL_DEFAULTS</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Var def-Var'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 281: 
 282:     <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 283:         <span class='perl-Comment def-Comment def-Syntax'># supply global config variables to the templates. Rather than pollute the name space</span>
 284:         <span class='perl-Comment def-Comment def-Syntax'># let's prefix them with cfg_, dawg. </span>
 285:        <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>map</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 286:           <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$k</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 287:           <span class='perl-String def-String'>'CFG_'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$k</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span>  <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$k</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 288:        <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>keys</span> <span class='perl-Var def-Var'>%CFG</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 289:        <span class='perl-Comment def-Comment def-Syntax'># supply global session variables to the template</span>
 290:        <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>map</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 291:           <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$k</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 292:           <span class='perl-String def-String'>'SES_'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$k</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span>  <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$k</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 293:        <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>keys</span> <span class='perl-Var def-Var'>%SES</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 294:       <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 295:         <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 296: <span class='def-SymbolStrong def-Symbol'>}</span>
 297: 
 298: 
 299: <span class='perl-Word def-Keyword'>sub</span> connect_db <span class='def-SymbolStrong def-Symbol'>{</span>
 300: 
 301:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$dsn</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 302:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DRIVER</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'mysql'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 303:         <span class='perl-Var def-Var'>$dsn</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"DBI:</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DRIVER</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>:database=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DATABASE</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;host=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBSERVER</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;port=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBPORT</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 304:     <span class='perl-Comment def-Comment def-Syntax'># Default to Postgres' style dsn for now</span>
 305:     <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 306:         <span class='perl-Var def-Var'>$dsn</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"dbi:</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DRIVER</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>:dbname=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DATABASE</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;"</span><span class='perl-Symb def-Symbol'>.</span>
 307:             <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBSERVER</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-String def-String'>"host=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBSERVER</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 308:             <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBOPTIONS</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-String def-String'>"options=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBOPTIONS</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 309:             <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBPORT</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-String def-String'>"port=</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBPORT</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>;"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 310:     <span class='def-SymbolStrong def-Symbol'>}</span>        
 311:     
 312:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$rv</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span> <span class='perl-Symb def-Symbol'>=</span>  <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBI</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-WordFun def-FunctionKeyword def-Keyword'>connect</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$dsn</span><span class='perl-Symb def-Symbol'>,</span>
 313:                <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBUSER</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DBPASS</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 314:                <span class='def-SymbolStrong def-Symbol'>{</span>
 315:                    <span class='perl-Var def-Var'>PrintError </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>,</span>
 316:                    <span class='perl-Var def-Var'>RaiseError </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Numb def-Number'>0</span><span class='perl-Symb def-Symbol'>,</span>
 317:                <span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 318:     <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$rv</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>                
 319: <span class='def-SymbolStrong def-Symbol'>}</span>
 320: 
 321: 
 322: 
 323: 
 324: 
 325: <span class='perl-Comment def-Comment def-Syntax'># Establish some defaults and provide a template to call CGI::Err with.</span>
 326: <span class='perl-Word def-Keyword'>sub</span> err <span class='def-SymbolStrong def-Symbol'>{</span>
 327: 
 328:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%args</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
 329:         <span class='perl-Var def-Var'>debug    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$DEBUG</span><span class='perl-Symb def-Symbol'>,</span>
 330:         <span class='perl-Var def-Var'>@_</span>
 331:     <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 332:     
 333:     <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Template</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 334: 
 335:     <span class='perl-Comment def-Comment def-Syntax'># We treat the header and footer differently since they rely on other values in the incoming hash. </span>
 336:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmpl</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTML</span><span class='perl-Symb def-Symbol'>::</span>Template<span class='def-Symbol'>(</span>
 337:         <span class='perl-Var def-Var'>die_on_bad_params</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='perl-Symb def-Symbol'>,</span>
 338:         <span class='perl-Var def-Var'>path</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTML_TEMPLATE_ROOT</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 339:         <span class='perl-Var def-Var'>filename</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'error.tmpl'</span>
 340:     <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 341:     
 342:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$args</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>debug</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 343:         <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$package</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$file</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$line</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$sub</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>caller</span><span class='def-Symbol'>(</span><span class='perl-Numb def-Number'>2</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='def-Symbol'>[</span><span class='perl-Numb def-Number'>0</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Numb def-Number'>2</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Numb def-Number'>3</span><span class='def-Symbol'>]</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 344:         <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$q</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>CGI</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 345:         <span class='perl-Var def-Var'>$args</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>debugging_text</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"Package: </span><span class='perl-Var def-Var'>$package</span><span class='perl-String def-String'>&lt;BR> File: </span><span class='perl-Var def-Var'>$file</span><span class='perl-String def-String'> &lt;BR>Line: </span><span class='perl-Var def-Var'>$line</span><span class='perl-String def-String'> &lt;BR> Subroutine: </span><span class='perl-Var def-Var'>$sub</span><span class='perl-String def-String'>&lt;P>"</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>Dump<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 346:     <span class='def-SymbolStrong def-Symbol'>}</span>
 347: 
 348:     <span class='perl-Var def-Var'>$args</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>page_title</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$args</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 349:     <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>%args</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>contact_email</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CONTACT_EMAIL</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 350: 
 351:     <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 352:   
 353: <span class='def-SymbolStrong def-Symbol'>}</span>
 354: 
 355: 
 356: <span class='perl-Comment def-Comment def-Syntax'># Currently not used</span>
 357: <span class='perl-Comment def-Comment def-Syntax'># sub get_user_item_rating {</span>
 358: <span class='perl-Comment def-Comment def-Syntax'>#   </span>
 359: <span class='perl-Comment def-Comment def-Syntax'>#   my ($user_id, $item_id, $category_id) = @_;</span>
 360: <span class='perl-Comment def-Comment def-Syntax'>#   </span>
 361: <span class='perl-Comment def-Comment def-Syntax'>#   my $rating = $DBH->selectrow_array("select rating from rating </span>
 362: <span class='perl-Comment def-Comment def-Syntax'>#       where (user_id = $user_id</span>
 363: <span class='perl-Comment def-Comment def-Syntax'>#       and item_id = $item_id</span>
 364: <span class='perl-Comment def-Comment def-Syntax'>#       and category_id = $category_id)");</span>
 365: <span class='perl-Comment def-Comment def-Syntax'>#   </span>
 366: <span class='perl-Comment def-Comment def-Syntax'>#   return $rating;</span>
 367: <span class='perl-Comment def-Comment def-Syntax'># </span>
 368: <span class='perl-Comment def-Comment def-Syntax'># }</span>
 369: 
 370: 
 371: 
 372: 
 373: <span class='perl-Comment def-Comment def-Syntax'># Used to to check to see whether the Input URL is a valid category, returns the category_id if true,</span>
 374: <span class='perl-Comment def-Comment def-Syntax'># or undef if false</span>
 375: <span class='perl-Word def-Keyword'>sub</span> check_cat_url <span class='def-SymbolStrong def-Symbol'>{</span>
 376:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 377:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 378:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@cat_ids</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 379:     
 380:    <span class='perl-Comment def-Comment def-Syntax'># Be forgiving about leading and trailing whitespace (delete it)</span>
 381:    <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='regexp-SymbClass def-Var'>\s</span><span class='regexp-MetaSymb def-Symbol'>+</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='regexp-SymbClass def-Var'>\s</span><span class='regexp-MetaSymb def-Symbol'>+</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>g</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 382: 
 383:    <span class='perl-Comment def-Comment def-Syntax'># If it's a static page, we want to get rid of HTML_ROOT_URL first</span>
 384:    <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTML_ROOT_URL</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 385:    
 386:    <span class='perl-Comment def-Comment def-Syntax'># Undo encoding</span>
 387: 
 388:    <span class='perl-Comment def-Comment def-Syntax'># underscores back to spaces</span>
 389:    <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>_</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'> </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>g</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 390: 
 391:    <span class='perl-Comment def-Comment def-Syntax'># x's, which represent characters that don't make good urls, get turned into %</span>
 392:    <span class='perl-Comment def-Comment def-Syntax'># for SQL LIKE pattern matching. -mls</span>
 393:    <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>x</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>%</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>g</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 394:     
 395:    <span class='perl-Comment def-Comment def-Syntax'># Split into directory names</span>
 396:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@cats</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Word def-Keyword'>split</span> <span class='perl-String def-String'>"/"</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$url</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 397: 
 398:    <span class='perl-Comment def-Comment def-Syntax'># The first element of the array is probably a null troublemaker. -mls</span>
 399:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$discard</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span> <span class='perl-Var def-Var'>@cats</span> <span class='perl-Word def-Keyword'>unless</span> <span class='perl-Var def-Var'>$cats</span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Numb def-Number'>0</span><span class='perl-Symb def-Symbol'>]</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 400:     
 401:    <span class='perl-Var def-Var'>@cats</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>reverse</span> <span class='perl-Var def-Var'>@cats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 402:     
 403:    <span class='perl-Comment def-Comment def-Syntax'># Create a SQL statement to see if this directory really exists. </span>
 404:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@from_bits</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@where_bits</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 405:    <span class='perl-Word def-Keyword'>for</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$i</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>0</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Var def-Var'>$i</span> <span class='perl-Symb def-Symbol'>&lt;</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$#cats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-Symb def-Symbol'>+</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 406:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$i1</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 407:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@from_bits</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"cas_category c</span><span class='perl-Var def-Var'>$i</span><span class='perl-String def-String'>"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 408:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@where_bits</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"c</span><span class='perl-Var def-Var'>$i1</span><span class='perl-String def-String'>.category_id = c</span><span class='perl-Var def-Var'>$i</span><span class='perl-String def-String'>.parent_id"</span> <span class='perl-Word def-Keyword'>unless</span> <span class='perl-Var def-Var'>$i</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$#cats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 409:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@where_bits</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"c</span><span class='perl-Var def-Var'>$i</span><span class='perl-String def-String'>.name LIKE "</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cats</span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>]</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 410:    <span class='def-SymbolStrong def-Symbol'>}</span>
 411:     
 412:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"SELECT c0.category_id FROM "</span><span class='perl-Symb def-Symbol'>.</span><span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>join</span> <span class='perl-String def-String'>', '</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@from_bits</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>" WHERE "</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Word def-Keyword'>join</span> <span class='perl-String def-String'>"</span><span class='regexp-Symbol def-StringContent def-String'>\n</span><span class='perl-String def-String'>and "</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@where_bits</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 413:    <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>" AND c</span><span class='perl-Var def-Var'>$#cats</span><span class='perl-String def-String'>.parent_id = </span><span class='def-NumberDec def-Number'>0</span><span class='perl-String def-String'>"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 414:     
 415:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$sql</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 416: 
 417:    <span class='perl-Comment def-Comment def-Syntax'>#If we made it this far, all's good. Return the $target_id</span>
 418:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$cat_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 419: <span class='def-SymbolStrong def-Symbol'>}</span>
 420: 
 421: <span class='perl-Comment def-Comment def-Syntax'># Before we compare a submitted URL to one in the database, let's reduce the chance that 2 equivalent URLS will appear different.</span>
 422: <span class='perl-Comment def-Comment def-Syntax'># We can lowercase the URL, and chop off standard directory prefixes. </span>
 423: <span class='perl-Word def-Keyword'>sub</span> base_url <span class='def-SymbolStrong def-Symbol'>{</span>
 424:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 425:     <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>%</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-MetaSymb def-Symbol'>.</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='perl-String def-String'>default</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>welcome</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>index</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-Symbol def-StringContent def-String'>\.</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='perl-String def-String'>cgi</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>s</span><span class='regexp-MetaSymb def-Symbol'>?</span><span class='perl-String def-String'>html</span><span class='regexp-MetaSymb def-Symbol'>?</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>tcl</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>adp</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>asp</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='perl-String def-String'>pl</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>%</span><span class='perl-Var def-Var'>$1</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>%</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>i</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 426:     <span class='perl-Word def-Keyword'>return</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$url</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 427: <span class='def-SymbolStrong def-Symbol'>}</span>
 428: 
 429: <span class='perl-Comment def-Comment def-Syntax'># returns the html page for "what's new" page</span>
 430: <span class='perl-Comment def-Comment def-Syntax'># deprecated. May go away in favor of historical_* run modes</span>
 431: <span class='perl-Word def-Keyword'>sub</span> html_item_new <span class='def-SymbolStrong def-Symbol'>{</span>
 432:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 433:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tbl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>::</span>most_recent<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>BUILD_NEW_CUTOFF</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 434:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%cats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 435:    <span class='perl-Word def-Keyword'>while</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$row</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span> <span class='perl-Var def-Var'>@$tbl</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 436:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@</span><span class='perl-Var def-Var'>{</span> <span class='perl-Var def-Var'>$cats</span><span class='perl-Symb def-Symbol'>{</span> <span class='perl-Var def-Var'>$row</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>]</span> <span class='perl-Symb def-Symbol'>}</span> <span class='perl-Var def-Var'>}</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$row</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Numb def-Number'>0</span><span class='perl-Symb def-Symbol'>]</span>
 437:    <span class='def-SymbolStrong def-Symbol'>}</span>
 438: 
 439:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@tmpl_cats</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$cut_off</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 440:    <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat_id</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>keys</span> <span class='perl-Var def-Var'>%cats</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 441:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 442:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>multi_link</span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>name<span class='def-Symbol'>(</span><span class='perl-String def-String'>'multi_link'</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 443:       <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item_id</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@</span><span class='perl-Var def-Var'>{</span> <span class='perl-Var def-Var'>$cats</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$cat_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Var def-Var'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 444:      <span class='perl-Var def-Var'>$cut_off</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 445:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 446:      <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>items</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"&lt;LI>"</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>output_html<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>date_added</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 447:       <span class='def-SymbolStrong def-Symbol'>}</span>    
 448:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@tmpl_cats</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%cat</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 449:    <span class='def-SymbolStrong def-Symbol'>}</span>
 450:     
 451:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmpl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'whats-new.tmpl'</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 452:   
 453:    <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 454:         <span class='perl-Var def-Var'>whats_new            </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>@tmpl_cats</span><span class='perl-Symb def-Symbol'>,</span>
 455:         <span class='perl-Var def-Var'>cutoff                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$cut_off</span><span class='perl-Symb def-Symbol'>,</span>
 456:         <span class='perl-Var def-Var'>page_title            </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>'What</span><span class='perl-Slash def-StringContent def-String'>\'</span><span class='perl-String def-String'>s New'</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 457:         <span class='perl-Symb def-Symbol'>&amp;</span>footer_html_tmpl
 458:            <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 459:   
 460:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 461: <span class='def-SymbolStrong def-Symbol'>}</span>
 462: 
 463: <span class='perl-Word def-Keyword'>sub</span> historical_month_index <span class='def-SymbolStrong def-Symbol'>{</span>
 464:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 465:    <span class='perl-Comment def-Comment def-Syntax'># default to the current month </span>
 466:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$month</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>historical_month</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 467:    <span class='perl-Comment def-Comment def-Syntax'># If nothing was passed in directly or in the form, this is the default view. </span>
 468:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$default</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 469:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$month</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 470:       <span class='perl-Var def-Var'>$default</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 471:       <span class='perl-Var def-Var'>$month</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"SELECT date_trunc('month',CURRENT_DATE)"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 472:    <span class='def-SymbolStrong def-Symbol'>}</span>
 473:    <span class='perl-Var def-Var'>$month</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$month</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 474: 
 475:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'historical-month-index.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 476: 
 477:    <span class='perl-Comment def-Comment def-Syntax'># get all the item_ids for a month</span>
 478:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$items</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectcol_arrayref<span class='def-Symbol'>(</span><span class='perl-String def-String'>"select </span>
 479: <span class='perl-String def-String'>    item_id </span>
 480: <span class='perl-String def-String'>    from cas_item_approved</span>
 481: <span class='perl-String def-String'>        WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date)) =</span>
 482: <span class='perl-String def-String'>            date_trunc('month',CAST(</span><span class='perl-Var def-Var'>$month</span><span class='perl-String def-String'> AS DATE))</span>
 483: <span class='perl-String def-String'>        ORDER BY COALESCE(historical_date,approved_date,insert_date) DESC "</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 484: 
 485:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$prev_month</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 486: <span class='perl-String def-String'>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 487: <span class='perl-String def-String'>    as previous_month</span>
 488: <span class='perl-String def-String'>    FROM cas_item_approved</span>
 489: <span class='perl-String def-String'>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 490: <span class='perl-String def-String'>        &lt; date_trunc('month',CAST(</span><span class='perl-Var def-Var'>$month</span><span class='perl-String def-String'> AS DATE))</span>
 491: <span class='perl-String def-String'>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date DESC</span>
 492: <span class='perl-String def-String'>    LIMIT </span><span class='def-NumberDec def-Number'>1</span><span class='perl-String def-String'>"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 493: 
 494:    <span class='perl-Comment def-Comment def-Syntax'># If there are no items in the default month,</span>
 495:    <span class='perl-Comment def-Comment def-Syntax'># and there are in the previous month, return that instead. </span>
 496:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>not</span> <span class='perl-Word def-Keyword'>scalar</span> <span class='perl-Var def-Var'>@$items</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$prev_month</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$default</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 497:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>historical_month_index<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$prev_month</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 498:    <span class='def-SymbolStrong def-Symbol'>}</span>
 499: 
 500:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@entries</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 501:    <span class='perl-Word def-Keyword'>for</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$items</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 502:       <span class='perl-Comment def-Comment def-Syntax'># We use static mode here because currently the edit link won't work because</span>
 503:       <span class='perl-Comment def-Comment def-Syntax'># we are requiring a category_id at the moment. -mls</span>
 504:        <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$_</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'static'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 505:     <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@entries</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-String def-String'>'item_html'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>output_html<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>date_added</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 506:    <span class='def-SymbolStrong def-Symbol'>}</span>
 507:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>prev_month   </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$prev_month</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 508:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 509:       <span class='perl-Var def-Var'>next_month   </span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 510: <span class='perl-String def-String'>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 511: <span class='perl-String def-String'>    as next_month</span>
 512: <span class='perl-String def-String'>    FROM cas_item_approved</span>
 513: <span class='perl-String def-String'>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 514: <span class='perl-String def-String'>        > date_trunc('month',CAST(</span><span class='perl-Var def-Var'>$month</span><span class='perl-String def-String'> AS DATE))</span>
 515: <span class='perl-String def-String'>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date ASC</span>
 516: <span class='perl-String def-String'>    LIMIT </span><span class='def-NumberDec def-Number'>1</span><span class='perl-String def-String'> "</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 517:      
 518:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'static'</span> <span class='perl-Word def-Keyword'>unless</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DYNAMIC_ONLY_P</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 519:      <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 520:       <span class='perl-Var def-Var'>month_as_text</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 521: <span class='perl-String def-String'>        SELECT to_char(CAST(</span><span class='perl-Var def-Var'>$month</span><span class='perl-String def-String'> AS DATE), 'FMMonth, YYYY') "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 522:        <span class='perl-Var def-Var'>entries</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>@entries</span><span class='perl-Symb def-Symbol'>,</span>
 523:       footer_html_tmpl<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$mode</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 524:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 525:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 526: <span class='def-SymbolStrong def-Symbol'>}</span>
 527: 
 528: <span class='perl-Comment def-Comment def-Syntax'># display historical index of all data. Pass in a year</span>
 529: <span class='perl-Comment def-Comment def-Syntax'># directly or through the FORM to view just one year. -mls </span>
 530: <span class='perl-Word def-Keyword'>sub</span> historical_all_index <span class='def-SymbolStrong def-Symbol'>{</span>
 531:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 532:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%in</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
 533:       <span class='perl-Var def-Var'>year </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 534:       <span class='perl-Var def-Var'>@_</span><span class='perl-Symb def-Symbol'>,</span>
 535:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 536:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'historical-all-index.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 537: 
 538:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$LoH</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectall_arrayref<span class='def-Symbol'>(</span><span class='perl-String def-String'>"select </span>
 539: <span class='perl-String def-String'>    extract(year from COALESCE(historical_date,approved_date,insert_date)::date) as year,</span>
 540: <span class='perl-String def-String'>    to_char( COALESCE(historical_date,approved_date,insert_date)::date, 'FMMonth, YYYY') as month_as_text,</span>
 541: <span class='perl-String def-String'>     date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date as month_as_date,</span>
 542: <span class='perl-String def-String'>    count(item_id) as items_in_month</span>
 543: <span class='perl-String def-String'>    from cas_item_approved "</span><span class='perl-Symb def-Symbol'>.</span>
 544:         <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$in</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-Symb def-Symbol'>&amp;</span> 
 545:        <span class='perl-String def-String'>"WHERE extract(year from COALESCE(historical_date,approved_date,insert_date)::date) = "</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$in</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>"</span>
 546: <span class='perl-String def-String'>      GROUP BY year,month_as_text, month_as_date</span>
 547: <span class='perl-String def-String'>      ORDER BY  month_as_date ASC"</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>Slice </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 548: 
 549:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%years</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 550:    <span class='perl-Word def-Keyword'>for</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$LoH</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 551:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$y</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$_</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 552:       <span class='perl-Var def-Var'>$years</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$y</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$y</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 553:       <span class='perl-Var def-Var'>$_</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>one_entry</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span> <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$_</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>items_in_month</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 554:       <span class='perl-Comment def-Comment def-Syntax'># add the global we need inside this loop</span>
 555:       <span class='perl-Var def-Var'>$_</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>cfg_cascade_cgi</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 556:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@</span><span class='perl-Var def-Var'>{</span> <span class='perl-Var def-Var'>$years</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$y</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>months</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Var def-Var'>}</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 557:    <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 558: 
 559:    <span class='perl-Comment def-Comment def-Syntax'># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
 560:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'static'</span> <span class='perl-Word def-Keyword'>unless</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DYNAMIC_ONLY_P</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 561:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 562:       <span class='perl-Var def-Var'>page_title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"Historical View of </span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>SYSTEM_NAME</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>"</span><span class='perl-Symb def-Symbol'>,</span>
 563:       footer_html_tmpl<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$mode</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 564:     <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 565:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>years</span><span class='perl-Symb def-Symbol'>=></span><span class='def-Symbol'>[</span><span class='perl-WordFun def-FunctionKeyword def-Keyword'>sort</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>$b</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Stream def-Path def-URI'>&lt;=></span> <span class='perl-Var def-Var'>$a</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>year</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>values</span> <span class='perl-Var def-Var'>%years</span> <span class='def-Symbol'>]</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 566:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 567: <span class='def-SymbolStrong def-Symbol'>}</span>
 568: 
 569: <span class='perl-Word def-Keyword'>sub</span> search_zip <span class='def-SymbolStrong def-Symbol'>{</span>
 570:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 571: 
 572:   <span class='perl-Comment def-Comment def-Syntax'># default to 50 miles. -mls</span>
 573:   <span class='perl-Comment def-Comment def-Syntax'># XXX another candidate for moving to the config file</span>
 574:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$radius</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'distance'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Numb def-Number'>50</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 575: 
 576:   <span class='perl-Comment def-Comment def-Syntax'># Convert kilometers to miles if needed</span>
 577:   <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>units</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'kilometers'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 578:     <span class='perl-Var def-Var'>$radius</span> <span class='perl-Symb def-Symbol'>*</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>.62140</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 579:   <span class='def-SymbolStrong def-Symbol'>}</span>
 580: 
 581:   <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'zipcode'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='regexp-SymbClass def-Var'>\d</span><span class='regexp-SymbClass def-Var'>\d</span><span class='regexp-SymbClass def-Var'>\d</span><span class='regexp-SymbClass def-Var'>\d</span><span class='regexp-SymbClass def-Var'>\d</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span> <span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span>
 582:     <span class='def-Symbol'>(</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'city'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span><span class='perl-String def-String'> </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-SymbClass def-Var'>\w</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-Symb def-Symbol'>&amp;</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'st'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span><span class='perl-String def-String'> </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-SymbClass def-Var'>\w</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 583:      <span class='perl-Comment def-Comment def-Syntax'># We trim off the first 28 characters of the city because</span>
 584:      <span class='perl-Comment def-Comment def-Syntax'># that's all that's in my zipcode database -mls</span>
 585:      <span class='perl-Comment def-Comment def-Syntax'># Find all the zipcodes that have a close enough latitude or</span>
 586:      <span class='perl-Comment def-Comment def-Syntax'># longitude</span>
 587:      <span class='perl-Comment def-Comment def-Syntax'># it's important to join on the item table-- this speeds thing up</span>
 588:      <span class='perl-Comment def-Comment def-Syntax'># A LOT In a less sophicated database (like MySQL), you could</span>
 589:      <span class='perl-Comment def-Comment def-Syntax'># accomplish the same thing with 3 seperate selects</span>
 590:      <span class='perl-Comment def-Comment def-Syntax'># If you are here to think about making this work for another</span>
 591:      <span class='perl-Comment def-Comment def-Syntax'># database, note that I'm doing a number of functions in the</span>
 592:      <span class='perl-Comment def-Comment def-Syntax'># database (substr,trim,upper), which are probably better done in</span>
 593:      <span class='perl-Comment def-Comment def-Syntax'># Perl to be more portable.</span>
 594:     <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>RaiseError</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 595:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$items</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 596:     <span class='perl-Word def-Keyword'>eval</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 597:        <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$matching_point</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 598: <span class='perl-String def-String'>        SELECT lon_lat </span>
 599: <span class='perl-String def-String'>      FROM cas_zipcodes zipcodes</span>
 600: <span class='perl-String def-String'>          WHERE zipcode = trim("</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>zipcode</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>")</span>
 601: <span class='perl-String def-String'>        OR (city = substring(upper(trim("</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>city</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>")) from </span><span class='def-NumberDec def-Number'>1</span><span class='perl-String def-String'> for </span><span class='def-NumberDec def-Number'>28</span><span class='perl-String def-String'>) </span>
 602: <span class='perl-String def-String'>            AND state_code = upper("</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>st</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>"))"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 603:        <span class='perl-Var def-Var'>$matching_point</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-Word def-Keyword'>undef</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 604:     <span class='perl-Var def-Var'>$items</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectall_arrayref<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 605: <span class='perl-String def-String'>SELECT item.*,category_id </span>
 606: <span class='perl-String def-String'> FROM cas_item item, cas_category_item_map category_item_map</span>
 607: <span class='perl-String def-String'> WHERE item.item_id = category_item_map.item_id </span>
 608: <span class='perl-String def-String'>   AND postal_code IN (</span>
 609: <span class='perl-String def-String'> SELECT distinct zipcode FROM cas_zipcodes zipcodes</span>
 610: <span class='perl-String def-String'>   WHERE item.postal_code = zipcodes.zipcode</span>
 611: <span class='perl-String def-String'>     AND (?::point &lt;@> lon_lat ) &lt; ? ) "</span><span class='perl-Symb def-Symbol'>,</span>
 612:     <span class='def-SymbolStrong def-Symbol'>{</span>  <span class='perl-Var def-Var'>Slice</span><span class='perl-Symb def-Symbol'>=></span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 613:         <span class='perl-Var def-Var'>$matching_point</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$radius</span>
 614:        <span class='def-Symbol'>)</span>
 615:       <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No Results'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Your search returned no results'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 616:     <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 617:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$@</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 618:        err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Database Error'</span><span class='perl-Symb def-Symbol'>,</span>
 619:        <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There was a database error when searching. This error has been logged.'</span><span class='def-Symbol'>)</span>
 620:     <span class='def-SymbolStrong def-Symbol'>}</span>
 621:     <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 622:        <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>search_results<span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>undef</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$items</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 623:     <span class='def-SymbolStrong def-Symbol'>}</span>
 624:   <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 625:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>TITLE </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'Missing Fields'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>MSG </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-ReType perl-Word def-Keyword'>q</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>{</span><span class='perl-String def-String'>You Must specify a city and state or a zipcode to search. That's the breaks. </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 626:   <span class='def-SymbolStrong def-Symbol'>}</span>
 627: <span class='def-SymbolStrong def-Symbol'>}</span>
 628: 
 629: 
 630: <span class='perl-Word def-Keyword'>sub</span> search_results  <span class='def-SymbolStrong def-Symbol'>{</span>
 631:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 632:   <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cat_ref</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$item_ref</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 633: 
 634:  <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No matches found'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No results were found matching your query'</span><span class='def-Symbol'>)</span> 
 635:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item_ref</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$cat_ref</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 636:     
 637:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@cats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 638:   <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$row</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$cat_ref</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 639:     <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$id</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$name</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$desc</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$items_below</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@$row</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 640:     <span class='perl-Word def-Keyword'>my</span>  <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>populate</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 641:     <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@cats</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-SymbolStrong def-Symbol'>{</span> 
 642:       <span class='perl-Var def-Var'>name         </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>relative<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$name</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 643:       <span class='perl-Var def-Var'>items_below </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$items_below</span><span class='perl-Symb def-Symbol'>,</span>
 644:       <span class='perl-Var def-Var'>description    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$desc</span>
 645:      <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 646:   <span class='def-SymbolStrong def-Symbol'>}</span>                 
 647:                       
 648:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@items</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 649:   <span class='perl-Comment def-Comment def-Syntax'># Note: I changed how this worked around 1.3.8</span>
 650:   <span class='perl-Comment def-Comment def-Syntax'># instead of passing in an array of item ids, we are now passing in</span>
 651:   <span class='perl-Comment def-Comment def-Syntax'># an array of hash references with item data</span>
 652:   <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item_ref</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$item_ref</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 653:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_ref</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>data</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_ref</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 654:     <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@items</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>output_html<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 655:   <span class='def-SymbolStrong def-Symbol'>}</span>
 656:     
 657:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmpl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'search-results.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 658:           
 659:     <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 660:       <span class='perl-Var def-Var'>cats                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>@cats</span><span class='perl-Symb def-Symbol'>,</span>
 661:       <span class='perl-Var def-Var'>items                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>CGI</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span>li<span class='def-Symbol'>(</span><span class='def-Symbol'>[</span><span class='perl-Var def-Var'>@items</span><span class='def-Symbol'>]</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 662:       <span class='perl-Symb def-Symbol'>&amp;</span>footer_html_tmpl
 663:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 664: 
 665:     <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 666: <span class='def-SymbolStrong def-Symbol'>}</span>    
 667: 
 668: <span class='perl-Word def-Keyword'>sub</span> illegal_chars <span class='def-SymbolStrong def-Symbol'>{</span>
 669:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'name'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>[</span><span class='perl-String def-String'>_</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>]</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 670:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Your Name contained the illegal character"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 671:         <span class='perl-String def-String'>" &lt;B></span><span class='perl-Var def-Var'>$1</span><span class='perl-String def-String'>&lt;/B>. "</span><span class='perl-Symb def-Symbol'>.</span>gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Go back and try again."</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 672:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Illegal Character"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$msg</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 673:      <span class='def-SymbolStrong def-Symbol'>}</span>
 674: 
 675: <span class='def-SymbolStrong def-Symbol'>}</span>
 676: 
 677: <span class='perl-Comment def-Comment def-Syntax'># check to  see if a category already exists</span>
 678: <span class='perl-Word def-Keyword'>sub</span> cat_already_exists <span class='def-SymbolStrong def-Symbol'>{</span>
 679:     <span class='perl-Comment def-Comment def-Syntax'># If they pass in a $cat_id, we assume this check is for an edit,</span>
 680:     <span class='perl-Comment def-Comment def-Syntax'># otherwise we assume it's for an addition. If we have it's</span>
 681:     <span class='perl-Comment def-Comment def-Syntax'># $cat_id, we can make sure it doesn't show up falsely as a</span>
 682:     <span class='perl-Comment def-Comment def-Syntax'># duplicate of itself. -mls</span>
 683:     <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$name</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$parent_id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 684:     <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$name</span> <span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-Symb def-Symbol'>&amp;</span> <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$parent_id</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>die</span> <span class='perl-String def-String'>"no category name and parent_id found"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 685: 
 686:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@bind</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$name</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$parent_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 687:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"select category_id from cas_category</span>
 688: <span class='perl-String def-String'>      where lower(name) =  ?</span>
 689: <span class='perl-String def-String'>      and   parent_id = ? "</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 690:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 691:         <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$cat_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 692:         <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>" category_id &lt;> ? "</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 693:     <span class='def-SymbolStrong def-Symbol'>}</span>
 694: 
 695:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>defined</span> <span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 696:          <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat_id</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'dynamic'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 697:          <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span>  gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"The Category you have submitted "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 698:              gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"is already in our database"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span> <span class='perl-String def-String'>':&lt;P>'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>name<span class='def-Symbol'>(</span><span class='perl-String def-String'>'plain'</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'&lt;P>'</span><span class='perl-Symb def-Symbol'>.</span>
 699:                  gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Try another!"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 700:          <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Category Exists"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$msg</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 701:     <span class='def-SymbolStrong def-Symbol'>}</span>                              
 702: <span class='def-SymbolStrong def-Symbol'>}</span>
 703: 
 704: <span class='perl-Comment def-Comment def-Syntax'># This tests for the case in which the category maps to directory name which is the same as an existing category</span>
 705: <span class='perl-Word def-Keyword'>sub</span> conflicts_with_existing_cat <span class='def-SymbolStrong def-Symbol'>{</span>
 706:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$name</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>name</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 707: 
 708:     <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Category</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 709:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$enc_name</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>::</span>encode_name<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$name</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 710: 
 711:     <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>parent_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-Word def-Keyword'>undef</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 712:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tbl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectall_arrayref<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 713: <span class='perl-String def-String'>        SELECT category_id, name</span>
 714: <span class='perl-String def-String'>            FROM cas_category</span>
 715: <span class='perl-String def-String'>            WHERE parent_id = ?</span>
 716: <span class='perl-String def-String'>                AND category_id != ?</span>
 717: <span class='perl-String def-String'>    "</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>parent_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 718:     
 719:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$tbl</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 720:         <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$row</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$tbl</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 721:             <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cat_id</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$name</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@$row</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 722:             <span class='perl-Var def-Var'>$name</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>::</span>encode_name<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$name</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 723:             <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$name</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$enc_name</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 724:                 <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"The Category you have submitted "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 725:                     gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"conflicts with a pre-existing one named &lt;B></span><span class='perl-Var def-Var'>$name</span><span class='perl-String def-String'>&lt;/B>"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 726:                     <span class='perl-String def-String'>'&lt;P>'</span><span class='perl-Symb def-Symbol'>.</span>gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Try another!"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 727:                 <span class='perl-Word def-Keyword'>return</span>     err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Category Conflict"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$msg</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 728:             <span class='def-SymbolStrong def-Symbol'>}</span> 
 729:         <span class='def-SymbolStrong def-Symbol'>}</span>
 730:     <span class='def-SymbolStrong def-Symbol'>}</span>
 731: <span class='def-SymbolStrong def-Symbol'>}</span>
 732: 
 733: <span class='perl-Comment def-Comment def-Syntax'># is the user logged in as one of the passed in roles?</span>
 734: <span class='perl-Comment def-Comment def-Syntax'># takes array of roles as input</span>
 735: <span class='perl-Word def-Keyword'>sub</span> is_role <span class='def-SymbolStrong def-Symbol'>{</span>
 736:    <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@roles</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-Word def-Keyword'>undef</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 737:     
 738:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$user_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 739: <span class='perl-String def-String'>        SELECT user_id </span>
 740: <span class='perl-String def-String'>        FROM cas_users</span>
 741: <span class='perl-String def-String'>        WHERE role in  ("</span><span class='perl-Symb def-Symbol'>.</span><span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>join</span> <span class='perl-String def-String'>','</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Word def-Keyword'>map</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>quote<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$_</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Var def-Var'>@roles</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>")</span>
 742: <span class='perl-String def-String'>            AND user_id = ?</span>
 743: <span class='perl-String def-String'>    "</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>    
 744:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$user_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 745: <span class='def-SymbolStrong def-Symbol'>}</span>
 746: 
 747: <span class='perl-Word def-Keyword'>sub</span> item_id_from_title <span class='def-SymbolStrong def-Symbol'>{</span>
 748:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$title</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 749:    <span class='perl-Var def-Var'>$title</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$cat_id</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-Word def-Keyword'>undef</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 750:    <span class='perl-Comment def-Comment def-Syntax'># strip leading and trailing new lines and spaces to make the form more copy/paste friendly</span>
 751:    <span class='perl-Var def-Var'>$title</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='regexp-SymbClass def-Var'>\s</span><span class='regexp-MetaSymb def-Symbol'>+</span><span class='regexp-MetaSymbStrong def-SymbolStrong def-Symbol'>|</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>[</span><span class='regexp-Symbol def-StringContent def-String'>\n</span><span class='regexp-Symbol def-StringContent def-String'>\r</span><span class='regexp-SymbClass def-Var'>\s</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>]</span><span class='regexp-MetaSymb def-Symbol'>+</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 752: 
 753:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 754: <span class='perl-String def-String'>        SELECT item.item_id </span>
 755: <span class='perl-String def-String'>            FROM cas_item item, cas_category_item_map category_item_map</span>
 756: <span class='perl-String def-String'>            WHERE lower(title) = ?</span>
 757: <span class='perl-String def-String'>                AND item.item_id = category_item_map.item_id</span>
 758: <span class='perl-String def-String'>                AND category_item_map.category_id = ? "</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 759:             <span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$title</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$cat_id</span>
 760:         <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>     
 761: <span class='def-SymbolStrong def-Symbol'>}</span>
 762: 
 763: 
 764: 
 765: <span class='perl-Comment def-Comment def-Syntax'># prepare the content used in the html footer</span>
 766: <span class='perl-Word def-Keyword'>sub</span> footer_html_tmpl <span class='def-SymbolStrong def-Symbol'>{</span>
 767:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 768:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%footer</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
 769:          <span class='perl-Var def-Var'>footer_cats                 </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>footer_cats<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$mode</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 770:         <span class='perl-Var def-Var'>version                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>VERSION</span><span class='perl-Symb def-Symbol'>}</span>
 771:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 772:      <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>%footer</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 773: <span class='def-SymbolStrong def-Symbol'>}</span>
 774: 
 775: <span class='perl-Word def-Keyword'>sub</span> front_page <span class='def-SymbolStrong def-Symbol'>{</span>
 776:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 777:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 778: 
 779:   <span class='perl-Comment def-Comment def-Syntax'># If we are in static mode, we just redirect and we're done</span>
 780:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$user_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 781:   <span class='perl-Comment def-Comment def-Syntax'># I don't remember why I set max_includes to be 5. -mls </span>
 782:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmpl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'front-page.tmpl'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>max_includes</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>5</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 783: 
 784: 
 785:   <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_states</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$total_countries</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$total_resources</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 786:     <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_states</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 787: <span class='perl-String def-String'>        SELECT count(distinct state) FROM cas_item WHERE state is not null and approval_state = 'approved' "</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 788: 
 789:     <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_countries</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 790: <span class='perl-String def-String'>        SELECT count(distinct country) FROM cas_item WHERE country is not null and approval_state = 'approved' "</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 791: 
 792:     <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_resources</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 793: <span class='perl-String def-String'>        SELECT count(*) FROM cas_item where approval_state = 'approved' "</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 794: 
 795:  <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$suggested_inserts</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$suggested_updates</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 796:   <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_admin</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 797:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DISPLAY_SUGGESTION_LINKS_P</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 798:       <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$suggested_inserts</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 799: <span class='perl-String def-String'>         SELECT count(item.item_id)</span>
 800: <span class='perl-String def-String'>            FROM cas_item item, cas_category_item_map category_item_map</span>
 801: <span class='perl-String def-String'>            WHERE item.item_id = category_item_map.item_id AND item.approval_state = 'needs_approval'"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 802:       <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$suggested_updates</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 803: <span class='perl-String def-String'>         SELECT count(item_update_id) FROM cas_item_suggested_updates"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 804:     <span class='def-SymbolStrong def-Symbol'>}</span>
 805:     <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>any_links_verified </span><span class='perl-Symb def-Symbol'>=></span> 
 806:         <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 807: <span class='perl-String def-String'>                SELECT item_id FROM cas_item WHERE url_verified_date is not null LIMIT </span><span class='def-NumberDec def-Number'>1</span><span class='perl-String def-String'>"</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 808:     <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>num_links_appear_stale </span><span class='perl-Symb def-Symbol'>=></span> 
 809:         <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
 810: <span class='perl-String def-String'>        SELECT count(item_id) FROM cas_item</span>
 811: <span class='perl-String def-String'>            WHERE url like 'http%' </span>
 812: <span class='perl-String def-String'>            AND</span>
 813: <span class='perl-String def-String'>             ( url_verified_date is null )</span>
 814: <span class='perl-String def-String'>               OR</span>
 815: <span class='perl-String def-String'>             ( url_verified_date &lt; (CURRENT_DATE - '</span><span class='def-NumberDec def-Number'>30</span><span class='perl-String def-String'> days'::interval)::date</span>
 816: <span class='perl-String def-String'>                   AND url_verified_date is not null )"</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 817:    <span class='def-SymbolStrong def-Symbol'>}</span>
 818:     <span class='perl-Comment def-Comment def-Syntax'># XXX editors will need their own select statement here</span>
 819:   
 820:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$subcats</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>sub_cats<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 821:   <span class='perl-Word def-Keyword'>for</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$i</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>0</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Var def-Var'>$i</span> <span class='perl-Symb def-Symbol'>&lt;</span> <span class='perl-Var def-Var'>@$subcats</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-Symb def-Symbol'>+</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 822:      <span class='perl-Comment def-Comment def-Syntax'># create a new category object</span>
 823:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span>Category <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$subcats</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>]</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>cat_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>        
 824:      <span class='perl-Comment def-Comment def-Syntax'># get the subsubcats for this subcat, if any</span>
 825:      <span class='perl-Var def-Var'>$subcats</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>[</span><span class='perl-Var def-Var'>$i</span><span class='perl-Symb def-Symbol'>]</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>subcats</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>sub_cats<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>include_items_below</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 826:   <span class='def-SymbolStrong def-Symbol'>}</span>
 827:  
 828:   <span class='perl-Comment def-Comment def-Syntax'># handle the "new items"</span>
 829:   <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$new_cutoff</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>@new_items</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 830:   <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tbl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>::</span>most_recent<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>FRONT_PAGE_NEW_CUTOFF</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 831:   <span class='perl-Comment def-Comment def-Syntax'># You may wonder why we bother computing the cutoff here when we have it already in a config variable</span>
 832:   <span class='perl-Comment def-Comment def-Syntax'># If the config variable says 10, and there are are only 9 items, this will correctly display "9"</span>
 833:   <span class='perl-Comment def-Comment def-Syntax'># Instead of announcing there are 10 items when there aren't. -mls</span>
 834:      <span class='perl-Var def-Var'>$new_cutoff</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$tbl</span> <span class='perl-Symb def-Symbol'>&lt;</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>FRONT_PAGE_NEW_CUTOFF</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-Symbol'>)</span> 
 835:        <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Word def-Keyword'>scalar</span> <span class='perl-Var def-Var'>@$tbl</span>
 836:      <span class='perl-Symb def-Symbol'>:</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>FRONT_PAGE_NEW_CUTOFF</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 837:      <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$row</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$tbl</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 838:     <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item_id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@$row</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 839:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 840:     <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@new_items</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>item_html </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>output_html<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>style</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'short'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 841:      <span class='def-SymbolStrong def-Symbol'>}</span>    
 842:   <span class='def-SymbolStrong def-Symbol'>}</span>
 843:      <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 844:        <span class='perl-Var def-Var'>new_items        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>@new_items</span><span class='perl-Symb def-Symbol'>,</span>
 845:        <span class='perl-Var def-Var'>new_cutoff        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$new_cutoff</span><span class='perl-Symb def-Symbol'>,</span>
 846:        <span class='perl-Var def-Var'>suggested_inserts    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$suggested_inserts</span><span class='perl-Symb def-Symbol'>,</span>
 847:        <span class='perl-Var def-Var'>suggested_updates    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$suggested_updates</span><span class='perl-Symb def-Symbol'>,</span>
 848:        <span class='perl-Var def-Var'>any_suggestions        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$suggested_updates</span><span class='perl-Symb def-Symbol'>+</span><span class='perl-Var def-Var'>$suggested_inserts</span><span class='perl-Symb def-Symbol'>,</span>
 849:        <span class='perl-Var def-Var'>sub_cats            </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$subcats</span><span class='perl-Symb def-Symbol'>,</span>
 850:        <span class='perl-Var def-Var'>role_admin         </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_admin</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 851:          <span class='perl-Var def-Var'>total_resources        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$total_resources</span><span class='perl-Symb def-Symbol'>,</span>
 852:          <span class='perl-Var def-Var'>total_states        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$total_states</span><span class='perl-Symb def-Symbol'>,</span>
 853:          <span class='perl-Var def-Var'>total_countries        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$total_countries</span><span class='perl-Symb def-Symbol'>,</span>
 854:          <span class='perl-Var def-Var'>page_title                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>SYSTEM_NAME</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 855:          <span class='perl-Var def-Var'>states_plural        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'state'</span><span class='perl-Symb def-Symbol'>.</span><span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_states</span> <span class='perl-Symb def-Symbol'>!</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-Symb def-Symbol'>&amp;</span> <span class='perl-String def-String'>'s'</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 856:          <span class='perl-Var def-Var'>countries_plural    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'countr'</span><span class='perl-Symb def-Symbol'>.</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$total_countries</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-String def-String'>'y'</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-String def-String'>'ies'</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 857:          <span class='perl-Var def-Var'>items                </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>get_item_html<span class='perl-Symb def-Symbol'>,</span>
 858:         <span class='perl-Var def-Var'>whats_new_link        </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>"</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/historical_month_index"</span><span class='perl-Symb def-Symbol'>,</span>
 859:     <span class='perl-Comment def-Comment def-Syntax'>#  ($FORM{mode} eq 'static') ? $CFG{WHATS_NEW_URL} : "$CFG{CASCADE_CGI}/historical_month_index",</span>
 860:         <span class='perl-Symb def-Symbol'>&amp;</span>footer_html_tmpl    
 861:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 862:   <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-String def-String'>'display_admin_links'</span><span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span><span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span> <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'dynamic'</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_admin</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>        
 863:   <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>expires</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'-3m'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>type</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'text/html'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 864:   <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 865: <span class='def-SymbolStrong def-Symbol'>}</span>
 866: 
 867: <span class='perl-Word def-Keyword'>sub</span> category_page <span class='def-SymbolStrong def-Symbol'>{</span>
 868:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 869:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 870:    <span class='perl-Var def-Var'>$cat_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span> 
 871:      <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Var def-Var'>$cat_id</span>  
 872:        <span class='perl-Symb def-Symbol'>:</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> 
 873:      <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span> 
 874:        <span class='perl-Symb def-Symbol'>:</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>check_cat_url<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>PATH_INFO</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 875: 
 876:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 877: 
 878:    <span class='perl-Comment def-Comment def-Syntax'># If the category didn't work out, it could be because it was for category that</span>
 879:    <span class='perl-Comment def-Comment def-Syntax'># has a static page, but doesn't have an entry in the database. </span>
 880:    <span class='perl-Comment def-Comment def-Syntax'># For that rare case, we return people to the front page by using category_id zero instead. -mls</span>
 881:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cat</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 882:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'static'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 883:      <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_type<span class='def-Symbol'>(</span><span class='perl-String def-String'>'redirect'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 884:      <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>url</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTML_ROOT_URL</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 885:      <span class='perl-Word def-Keyword'>return</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 886:       <span class='def-SymbolStrong def-Symbol'>}</span>
 887:       <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 888:      <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>front_page<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 889:        <span class='def-SymbolStrong def-Symbol'>}</span>
 890:    <span class='def-SymbolStrong def-Symbol'>}</span>
 891: 
 892:    <span class='perl-Comment def-Comment def-Syntax'>#if they want a static category, we redirect them</span>
 893:    <span class='perl-Comment def-Comment def-Syntax'># redirecting the dynamic page would create a loop. -mls</span>
 894:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'static'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 895:        <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_type<span class='def-Symbol'>(</span><span class='perl-String def-String'>'redirect'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 896:        <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>url</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>name<span class='def-Symbol'>(</span><span class='perl-String def-String'>'full_url'</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 897:    <span class='def-SymbolStrong def-Symbol'>}</span>
 898:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 899:        <span class='perl-Comment def-Comment def-Syntax'># make an exception for the top category</span>
 900:        <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>front_page <span class='perl-Word def-Keyword'>if</span> <span class='perl-Var def-Var'>$cat_id</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>0</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 901: 
 902:        <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'category.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 903:        <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>html_page<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 904:        <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 905:    <span class='def-SymbolStrong def-Symbol'>}</span>
 906: <span class='def-SymbolStrong def-Symbol'>}</span>
 907: 
 908: <span class='perl-Word def-Keyword'>sub</span> item_add_form <span class='def-SymbolStrong def-Symbol'>{</span>
 909:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 910:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$errs</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 911: 
 912:    <span class='perl-Comment def-Comment def-Syntax'># If we aren't passed a type_id, we use the default for this category. </span>
 913:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$type_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>type_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 914:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>not</span> <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$type_id</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>and</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 915:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 916:       <span class='perl-Var def-Var'>$type_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>default_type_id<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>  
 917:    <span class='def-SymbolStrong def-Symbol'>}</span>
 918:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>type_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$type_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 919:    <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>expires</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'-3m'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>type</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'text/html'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 920: 
 921:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'items/'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>type_tech_name<span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'-form.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 922:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 923:       <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>html_form<span class='perl-Symb def-Symbol'>,</span>
 924:       <span class='perl-Var def-Var'>%$errs</span>
 925:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 926: 
 927:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 928: <span class='def-SymbolStrong def-Symbol'>}</span>
 929: 
 930: <span class='perl-Word def-Keyword'>sub</span> item_edit_form <span class='def-SymbolStrong def-Symbol'>{</span>
 931:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 932:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$errs</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 933:    <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>defined</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'item_id'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> 
 934:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Insufficient Information"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> 
 935:            <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span>
 936:              gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"There must be an item_id or title or item_update_id "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
 937:                gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"present to edit the item"</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 938:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$ItemId</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$Table</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$orig_item_html</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 939:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$change_cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 940:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 941:      <span class='perl-Var def-Var'>$ItemId</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 942:      <span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'cas_item_suggested_updates'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 943:      
 944:    <span class='def-SymbolStrong def-Symbol'>}</span>
 945: 
 946:    <span class='perl-Comment def-Comment def-Syntax'># XXX For now we assume that if people are using a title to update the item</span>
 947:    <span class='perl-Comment def-Comment def-Syntax'># They are a user</span>
 948:    <span class='perl-Word def-Keyword'>elsif</span> <span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>not</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 949:      <span class='perl-Var def-Var'>$ItemId</span> <span class='perl-Symb def-Symbol'>=</span> item_id_from_title<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span>
 950:        <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No Matches Found'</span><span class='perl-Symb def-Symbol'>,</span>
 951:        <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There were no items found with that title in this category.                 Try returning to the category and copying and pasting the item title precisely.</span>
 952: <span class='perl-String def-String'>                It</span><span class='perl-Slash def-StringContent def-String'>\'</span><span class='perl-String def-String'>s also possible that the item no longer exists in the database, although </span>
 953: <span class='perl-String def-String'>                it still appears on the website.         </span>
 954: <span class='perl-String def-String'>                '</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 955:      <span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'cas_item'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 956:      <span class='perl-Var def-Var'>$change_cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>0</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 957:    <span class='def-SymbolStrong def-Symbol'>}</span>
 958:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>     
 959:      <span class='perl-Var def-Var'>$ItemId</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 960:      <span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'cas_item'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 961:    <span class='def-SymbolStrong def-Symbol'>}</span>    
 962:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span>
 963:      <span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
 964:     <span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$ItemId</span><span class='perl-Symb def-Symbol'>,</span>
 965:     <span class='perl-Var def-Var'>table</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$Table</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>  
 966:    <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No Item Found'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No Item found with that item_id'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 967:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'items/'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>type_tech_name<span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'-form.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 968: 
 969:     <span class='perl-Comment def-Comment def-Syntax'># Get the HTML for the original item to display as a comparison (if that applies)</span>
 970:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'cas_item_suggested_updates'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 971:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$orig_item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>field<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item_id'</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 972:       <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>orig_item_html</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$orig_item</span><span class='perl-Symb def-Symbol'>-></span>output_html<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 973:    <span class='def-SymbolStrong def-Symbol'>}</span>
 974:       
 975:    <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>expires</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'-3m'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>type</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'text/html'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 976:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
 977:       <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>html_form<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>change_category</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$change_cat</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 978:       <span class='perl-Var def-Var'>%$errs</span><span class='perl-Symb def-Symbol'>,</span>
 979:  <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 980:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 981: <span class='def-SymbolStrong def-Symbol'>}</span>
 982: 
 983: <span class='perl-Word def-Keyword'>sub</span> item_suggest_add <span class='def-SymbolStrong def-Symbol'>{</span>
 984:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
 985:    
 986:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 987:    
 988:    <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>validate_form<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 989: 
 990:    <span class='perl-Comment def-Comment def-Syntax'># if there are errors, return the errors</span>
 991:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>missing <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>invalid<span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 992:       <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 993:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$fif</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
 994:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$fif</span><span class='perl-Symb def-Symbol'>-></span>fill<span class='def-Symbol'>(</span>
 995:      <span class='perl-Var def-Var'>scalarref </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_add_form<span class='def-Symbol'>(</span>
 996:         error_marks<span class='def-Symbol'>(</span> <span class='def-Symbol'>[</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>missing <span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-Symbol'>[</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>invalid <span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>validation_msgs <span class='def-Symbol'>)</span>    
 997:        <span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 998:      <span class='perl-Var def-Var'>fobject </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
 999:    <span class='def-SymbolStrong def-Symbol'>}</span>
1000: 
1001:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%params</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>already_exists<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1002:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$params</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>self_html</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1003:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item-duplicate.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1004:       <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>%params</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1005:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1006:    <span class='def-SymbolStrong def-Symbol'>}</span>
1007: 
1008:    <span class='perl-Comment def-Comment def-Syntax'># are we suggesting an update are actually making one? </span>
1009:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$send_alerts_p</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1010:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_admin</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_editor</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1011:       <span class='perl-Var def-Var'>$send_alerts_p</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1012:    <span class='def-SymbolStrong def-Symbol'>}</span>
1013:    
1014:    <span class='perl-Comment def-Comment def-Syntax'># add the item to the database</span>
1015:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1016:    <span class='perl-Word def-Keyword'>eval</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>$item_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>insert <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1017:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$@</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1018:       <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Insert Failed'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"The item could not be inserted due to the following error:&lt;BR></span><span class='perl-Var def-Var'>$@</span><span class='perl-String def-String'>"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1019:    <span class='def-SymbolStrong def-Symbol'>}</span>    
1020: 
1021:    <span class='perl-Comment def-Comment def-Syntax'># send email alerts </span>
1022:    <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1023:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>send_alerts<span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1024:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'emails/item-alert-new.txt'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1025:      <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>$msg</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1026:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>open</span><span class='def-Symbol'>(</span>MAIL<span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"|</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>MAILPROG</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>    -t"</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> 
1027:        err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Error Opening Mail Program'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There was an error opening the mail program'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1028:      <span class='perl-Word def-Keyword'>print</span> MAIL <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1029:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>close</span><span class='def-Symbol'>(</span>MAIL<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1030:    <span class='def-SymbolStrong def-Symbol'>}</span>
1031: 
1032: 
1033:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_editor</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1034:       <span class='perl-Comment def-Comment def-Syntax'># Return to the category_id we came from. </span>
1035:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>category_page<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>orig_category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1036:    <span class='def-SymbolStrong def-Symbol'>}</span>
1037:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1038:       <span class='perl-Comment def-Comment def-Syntax'># XXX We should probably eventually great a page to thank people specifically for suggesting</span>
1039:       <span class='perl-Comment def-Comment def-Syntax'># an addition, but the current message is generic enough for now. -mls </span>
1040:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_suggest_update_thanks<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1041:    <span class='def-SymbolStrong def-Symbol'>}</span>
1042: <span class='def-SymbolStrong def-Symbol'>}</span>
1043: 
1044: <span class='perl-Word def-Keyword'>sub</span> item_suggest_update_form <span class='def-SymbolStrong def-Symbol'>{</span>
1045:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1046:   <span class='perl-Word def-Keyword'>defined</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> 
1047:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"No Category ID specified"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> 
1048:      <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"There must be a category_id "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"present for this script to work"</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1049:      
1050:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Category</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1051: 
1052:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmpl</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item-suggest-update.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1053:   <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
1054:     <span class='perl-Var def-Var'>plain      </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>name<span class='def-Symbol'>(</span><span class='perl-String def-String'>'plain'</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1055:     <span class='perl-Var def-Var'>category_id </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1056:     <span class='perl-Var def-Var'>mode    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1057:     <span class='perl-Symb def-Symbol'>&amp;</span>footer_html_tmpl
1058:    <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1059:   <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$tmpl</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1060: <span class='def-SymbolStrong def-Symbol'>}</span>
1061: 
1062: <span class='perl-Word def-Keyword'>sub</span> item_edit <span class='def-SymbolStrong def-Symbol'>{</span>
1063:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1064: 
1065:    <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'item_id'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> 
1066:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"Insufficient Information"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> 
1067:            <span class='perl-Var def-Var'>msg </span><span class='perl-Symb def-Symbol'>=></span> gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"There must be an item_id or item_update_id "</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>.</span>
1068:                gettext<span class='def-Symbol'>(</span><span class='perl-String def-String'>"present to edit the item"</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1069:   <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$ItemId</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$Table</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$return_mode</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1070:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1071:      <span class='perl-Var def-Var'>$ItemId</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_update_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1072:      <span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'cas_item_suggested_updates'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1073:      <span class='perl-Var def-Var'>$return_mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'needs_approval_summary'</span>
1074:    <span class='def-SymbolStrong def-Symbol'>}</span>
1075:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>     
1076:      <span class='perl-Var def-Var'>$ItemId</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1077:      <span class='perl-Var def-Var'>$Table</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'cas_item'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1078:    <span class='def-SymbolStrong def-Symbol'>}</span>
1079: 
1080:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span>
1081:     <span class='perl-Comment def-Comment def-Syntax'>#category_id=>$FORM{category_id},</span>
1082:     <span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$ItemId</span><span class='perl-Symb def-Symbol'>,</span>
1083:     <span class='perl-Var def-Var'>table</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$Table</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1084:   <span class='perl-Var def-Var'>$return_mode</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>field<span class='def-Symbol'>(</span><span class='perl-String def-String'>'approval_state'</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'needs_approval'</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-String def-String'>'needs_approval_summary'</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-String def-String'>'category_page'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1085:   
1086: 
1087:   <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>validate_form<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1088: 
1089:    <span class='perl-Comment def-Comment def-Syntax'># if there are errors, return the errors</span>
1090:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>missing <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>invalid<span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1091:       <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1092:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$fif</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1093:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$fif</span><span class='perl-Symb def-Symbol'>-></span>fill<span class='def-Symbol'>(</span>
1094:      <span class='perl-Var def-Var'>scalarref </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_edit_form<span class='def-Symbol'>(</span> 
1095:         error_marks<span class='def-Symbol'>(</span> <span class='def-Symbol'>[</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>missing <span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-Symbol'>[</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>invalid <span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>validation_msgs<span class='def-Symbol'>)</span>
1096:        <span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1097:      <span class='perl-Var def-Var'>fobject </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query
1098:     <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1099:    <span class='def-SymbolStrong def-Symbol'>}</span>
1100: 
1101:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%params</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>already_exists<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1102:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$params</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>self_html</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1103:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item-duplicate.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1104:       <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>%params</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1105:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1106:    <span class='def-SymbolStrong def-Symbol'>}</span>
1107: 
1108:     <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$field</span> <span class='def-Symbol'>(</span><span class='perl-String def-String'>'state'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>'country'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1109:         <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>Delete<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$field</span><span class='def-Symbol'>)</span> <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span>  <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$field</span><span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>!</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-Numb def-Number'>2</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1110:     <span class='def-SymbolStrong def-Symbol'>}</span>
1111: 
1112:   <span class='perl-Comment def-Comment def-Syntax'># Users just suggest edits, editors and admins actually make them</span>
1113:   <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_admin</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>role_editor</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1114:     <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Admin</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1115:     <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>update<span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1116:        <span class='perl-Comment def-Comment def-Syntax'># update this form variable to return the category we came from. </span>
1117:        <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>category_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>orig_category_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1118:        <span class='perl-Comment def-Comment def-Syntax'># XXX It's only safe for admins to use this internal redirection</span>
1119:        <span class='perl-Comment def-Comment def-Syntax'># because it by-passes the auth checking for run modes in setup(). -mls</span>
1120:        <span class='perl-Comment def-Comment def-Syntax'># If $FORM{return_rm} is present, it supercedes the default return_mode. </span>
1121:        <span class='perl-Var def-Var'>$return_mode</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Var def-Var'>$return_mode</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1122:        <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$out</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Word def-Keyword'>eval</span><span class='def-Symbol'>(</span><span class='perl-String def-String'>'$self->'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$return_mode</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
1123:        <span class='perl-Var def-Var'>$@</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Word def-Keyword'>die</span> <span class='perl-String def-String'>"error run mode </span><span class='perl-Var def-Var'>$return_mode</span><span class='perl-String def-String'> was </span><span class='perl-Var def-Var'>$@</span><span class='perl-String def-String'>"</span><span class='perl-Symb def-Symbol'>:</span> <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$out</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1124:     <span class='def-SymbolStrong def-Symbol'>}</span>
1125:     <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1126:        err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Item Not Updated'</span><span class='perl-Symb def-Symbol'>,</span>
1127:         <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'The item was not updated. The database returned the error: '</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$DBI::errstr</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1128:     <span class='def-SymbolStrong def-Symbol'>}</span>
1129:   <span class='def-SymbolStrong def-Symbol'>}</span>
1130:   <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1131:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$update_id</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1132:       <span class='perl-Word def-Keyword'>eval</span> <span class='def-SymbolStrong def-Symbol'>{</span><span class='perl-Var def-Var'>$update_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>suggest_update<span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1133:       <span class='perl-Var def-Var'>$@</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Insert Failed'</span><span class='perl-Symb def-Symbol'>,</span>
1134:     <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"Inserting that suggested update failed with an unexpected error.</span>
1135: <span class='perl-String def-String'>                   The error was: </span><span class='perl-Var def-Var'>$@</span><span class='perl-String def-String'>"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1136:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>send_alerts<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$update_id</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1137:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'emails/item-alert-update.txt'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1138:      <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$msg</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1139:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>open</span><span class='def-Symbol'>(</span>MAIL<span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"|</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>MAILPROG</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'> -t"</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> 
1140:        err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Error Opening Mail Program'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There was an error opening the mail program'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1141:      <span class='perl-Word def-Keyword'>print</span> MAIL <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1142:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>close</span><span class='def-Symbol'>(</span>MAIL<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1143:        <span class='def-SymbolStrong def-Symbol'>}</span>
1144:      <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_suggest_update_thanks
1145:   <span class='def-SymbolStrong def-Symbol'>}</span>
1146: <span class='def-SymbolStrong def-Symbol'>}</span>
1147: 
1148: <span class='perl-Word def-Keyword'>sub</span> item_suggest_update_thanks <span class='def-SymbolStrong def-Symbol'>{</span>
1149:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1150:   <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item_suggest_update_thanks.html'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1151:   <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>footer_html_tmpl<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1152:   <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1153: <span class='def-SymbolStrong def-Symbol'>}</span>
1154: 
1155: <span class='perl-Word def-Keyword'>sub</span> login_form <span class='def-SymbolStrong def-Symbol'>{</span>
1156:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1157: 
1158:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$return_rm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1159:    <span class='perl-Comment def-Comment def-Syntax'># If we have been passed an explicit return_rm, we use that first. </span>
1160:    <span class='def-SymbolStrong def-Symbol'>{</span>
1161:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>$return_rm</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Word def-Keyword'>last</span> <span class='def-SymbolStrong def-Symbol'>}</span>
1162:       
1163:       <span class='perl-Comment def-Comment def-Syntax'># If we are being call from another run mode, we return there.</span>
1164:       <span class='perl-Comment def-Comment def-Syntax'># Otherwise, we return to their homepage </span>
1165:       <span class='perl-Var def-Var'>$return_rm</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-String def-String'>login</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-String def-String'>'pvt_home'</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1166:    <span class='def-SymbolStrong def-Symbol'>}</span>
1167: 
1168:    <span class='perl-Comment def-Comment def-Syntax'># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
1169:    <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'static'</span> <span class='perl-Word def-Keyword'>unless</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DYNAMIC_ONLY_P</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1170: 
1171:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'register-index.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1172: 
1173:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> 
1174:       <span class='perl-Var def-Var'>referred    </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>ne</span> <span class='perl-String def-String'>'login'</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1175:       <span class='perl-Var def-Var'>return_rm   </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$return_rm</span><span class='perl-Symb def-Symbol'>,</span>
1176:       <span class='perl-Var def-Var'>query_string </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>escapeHTML<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>query_string<span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1177:      footer_html_tmpl<span class='def-Symbol'>(</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1178: 
1179:    <span class='perl-Comment def-Comment def-Syntax'># Expire the existing cookie, just for good measure. </span>
1180:    <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>cookie</span><span class='perl-Symb def-Symbol'>=></span>create_cookie<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>session_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>'-3M'</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1181:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1182: <span class='def-SymbolStrong def-Symbol'>}</span>
1183: 
1184: <span class='perl-Word def-Keyword'>sub</span> login_process <span class='def-SymbolStrong def-Symbol'>{</span>
1185:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1186:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$user_id</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$user_state</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$role</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
1187: <span class='perl-String def-String'>     SELECT user_id,user_state,role</span>
1188: <span class='perl-String def-String'>      FROM cas_users</span>
1189: <span class='perl-String def-String'>      WHERE lower(email) = ?"</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1190:    <span class='perl-Comment def-Comment def-Syntax'># If we recognize your email address</span>
1191:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$user_id</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1192:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$user_state</span> <span class='perl-Symb def-Symbol'>eq</span> <span class='perl-String def-String'>'authorized'</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1193:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$recognize_both</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
1194: <span class='perl-String def-String'>            SELECT user_id </span>
1195: <span class='perl-String def-String'>                FROM cas_users users</span>
1196: <span class='perl-String def-String'>                WHERE users.user_id = </span><span class='perl-Var def-Var'>$user_id</span><span class='perl-String def-String'> </span>
1197: <span class='perl-String def-String'>                    AND password = ?"</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>password</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1198: 
1199:      <span class='perl-Comment def-Comment def-Syntax'># If we recognize your password, authorize and redirect you</span>
1200:      <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$recognize_both</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1201:         <span class='perl-Comment def-Comment def-Syntax'>#my %session = validate_session();</span>
1202:         add_userid_to_session<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%SES</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$user_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1203: 
1204:         <span class='perl-Comment def-Comment def-Syntax'># if return_rm starts with 'http' we assume it's a </span>
1205:         <span class='perl-Comment def-Comment def-Syntax'># full URL and use that. Otherwise, return_rm should be a run mode</span>
1206:         <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$url</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1207:         <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-String def-String'>http</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1208:             <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1209:         <span class='def-SymbolStrong def-Symbol'>}</span>
1210:         <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1211:             <span class='perl-Var def-Var'>$url</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-String def-String'>"</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>?</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>query_string</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
1212:         <span class='def-SymbolStrong def-Symbol'>}</span>
1213: 
1214:         <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span>
1215:            <span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>cookie</span><span class='perl-Symb def-Symbol'>=></span>create_cookie<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>session_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1216:            <span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>url</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$url</span><span class='perl-Symb def-Symbol'>,</span>
1217:          <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1218: 
1219:         <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_type<span class='def-Symbol'>(</span><span class='perl-String def-String'>'redirect'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1220:         <span class='perl-Word def-Keyword'>return</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1221:      <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1222:         <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Bad Password'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-ReType perl-Word def-Keyword'>qq</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span><span class='perl-String def-String'>The password is not correct.</span>
1223: <span class='perl-String def-String'>                   If you've forgotten it, </span>
1224: <span class='perl-String def-String'>              &lt;a href="</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/password_mail_forgotten?user_id=</span><span class='perl-Var def-Var'>$user_id</span><span class='perl-String def-String'>">we can mail it to you.&lt;/A></span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1225:      <span class='def-SymbolStrong def-Symbol'>}</span>
1226:       <span class='def-SymbolStrong def-Symbol'>}</span> 
1227:       <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1228:      <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Inactive account'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Your account is no longer active'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1229:       <span class='def-SymbolStrong def-Symbol'>}</span>
1230:    <span class='def-SymbolStrong def-Symbol'>}</span>
1231:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1232:       <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'User not found'</span><span class='perl-Symb def-Symbol'>,</span>
1233:          <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No user was not with that email address'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1234:    <span class='def-SymbolStrong def-Symbol'>}</span>
1235: <span class='def-SymbolStrong def-Symbol'>}</span>
1236: 
1237: <span class='perl-Comment def-Comment def-Syntax'># XXX maybe this run mode should really be Auth.pm. -mls</span>
1238: <span class='perl-Word def-Keyword'>sub</span> logout <span class='def-SymbolStrong def-Symbol'>{</span>
1239:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1240:    <span class='perl-Comment def-Comment def-Syntax'># We don't want to validate the session, since that would redirect them to register</span>
1241:    <span class='perl-Comment def-Comment def-Syntax'># if they are already logged out. Instead, we just grab the cookie directly. </span>
1242:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%session</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>session_id </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>cookie<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>SESSION_COOKIE_NAME</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1243:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Auth</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1244:    remove_userid_from_session<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%session</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1245:    <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>header_props<span class='def-Symbol'>(</span> <span class='perl-Symb def-Symbol'>-</span><span class='perl-Var def-Var'>cookie</span><span class='perl-Symb def-Symbol'>=></span>create_cookie<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$session</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>session_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>'-3M'</span><span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1246:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'register-logout.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1247:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
1248:       <span class='perl-Var def-Var'>top_url    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>!</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DYNAMIC_ONLY_P</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>?</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTML_ROOT_URL</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>:</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1249:       <span class='perl-Var def-Var'>return_rm </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTTP_REFERER</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1250:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1251: <span class='def-SymbolStrong def-Symbol'>}</span>
1252:      
1253: <span class='perl-Word def-Keyword'>sub</span> register_form <span class='def-SymbolStrong def-Symbol'>{</span>
1254:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1255:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$errs</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1256: 
1257:    <span class='perl-Comment def-Comment def-Syntax'># We don't want to pass through the run mode and confuse the</span>
1258:    <span class='perl-Comment def-Comment def-Syntax'># system. -mls</span>
1259:    <span class='perl-Word def-Keyword'>delete</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1260:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'register-form.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1261:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>  
1262:       <span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>return_rm</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1263:       <span class='perl-Var def-Var'>query_string </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>escapeHTML<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>query_string</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> 
1264:       <span class='perl-Var def-Var'>%$errs</span><span class='perl-Symb def-Symbol'>,</span>
1265:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1266:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1267: <span class='def-SymbolStrong def-Symbol'>}</span>
1268: 
1269: <span class='perl-Word def-Keyword'>sub</span> register_process <span class='def-SymbolStrong def-Symbol'>{</span>
1270:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1271:    <span class='perl-Comment def-Comment def-Syntax'># validate form</span>
1272:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Data</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>FormValidator</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1273:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%email_validation</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>email </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'email'</span><span class='def-Symbol'>)</span> <span class='perl-Word def-Keyword'>if</span> <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>VERIFY_EMAILS_P</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1274:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$validator</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Data</span><span class='perl-Symb def-Symbol'>::</span>FormValidator<span class='def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>{</span>
1275:       <span class='perl-Var def-Var'>form </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-SymbolStrong def-Symbol'>{</span>
1276:     <span class='perl-Var def-Var'>required </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-Symbol'>[</span><span class='perl-ReType perl-Word def-Keyword'>qw</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>first_names last_name email password password_confirmation</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span>
1277:     <span class='perl-Var def-Var'>filters </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'trim'</span><span class='perl-Symb def-Symbol'>,</span>
1278:     <span class='perl-Var def-Var'>constraints </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-SymbolStrong def-Symbol'>{</span>
1279:        <span class='perl-Var def-Var'>%email_validation</span><span class='perl-Symb def-Symbol'>,</span>
1280:        <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1281:     <span class='def-SymbolStrong def-Symbol'>}</span>
1282:      <span class='def-SymbolStrong def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1283:      <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$missing</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$invalid</span> <span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$validator</span><span class='perl-Symb def-Symbol'>-></span>validate<span class='def-Symbol'>(</span>  <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%FORM</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"form"</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1284: 
1285:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msgs</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1286:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>password</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>ne</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>password_confirmation</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1287:       <span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>password</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'Password and Confirmation do not match.'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1288:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@$invalid</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-Symbol'>(</span><span class='perl-String def-String'>'password'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>'password_confirmation'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1289:    <span class='def-SymbolStrong def-Symbol'>}</span>
1290: 
1291:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>grep</span><span class='perl-String def-String'> </span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-MetaSymb def-Symbol'>^</span><span class='perl-String def-String'>email</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@$invalid</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1292:       <span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'Invalid Email format'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1293:    <span class='def-SymbolStrong def-Symbol'>}</span>
1294: 
1295:    <span class='perl-Comment def-Comment def-Syntax'># Are they already registered with this email address?</span>
1296:    <span class='perl-Comment def-Comment def-Syntax'># If the user_id return is greater than zero, they are. </span>
1297:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$uid</span> <span class='perl-Symb def-Symbol'>=</span> 
1298:            <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"SELECT user_id FROM cas_users WHERE lower(email) = ?"</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>0</span> <span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1299:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@$invalid</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>'email'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1300:       <span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-ReType perl-Word def-Keyword'>qq</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span><span class='perl-String def-String'>Already in system. </span>
1301: <span class='perl-String def-String'>       ( &lt;a href="</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/password_mail_forgotten?user_id=</span><span class='perl-Var def-Var'>$uid</span><span class='perl-String def-String'>">Send password to this address&lt;/a>&amp;nbsp;)</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1302:    <span class='def-SymbolStrong def-Symbol'>}</span>
1303: 
1304:    <span class='perl-Comment def-Comment def-Syntax'># if there are errors, return the errors</span>
1305:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$missing</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>@$invalid</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1306:       <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1307:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$fif</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTML</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>FillInForm</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1308:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$fif</span><span class='perl-Symb def-Symbol'>-></span>fill<span class='def-Symbol'>(</span>
1309:      <span class='perl-Var def-Var'>scalarref </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>register_form<span class='def-Symbol'>(</span>
1310:         error_marks<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>$missing</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$invalid</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$msgs</span><span class='def-Symbol'>)</span>
1311:        <span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1312:      <span class='perl-Var def-Var'>fobject </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span>
1313:    <span class='def-SymbolStrong def-Symbol'>}</span>
1314:    <span class='perl-Comment def-Comment def-Syntax'># otherwise, return login_process with the info we've got</span>
1315:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1316:       <span class='perl-Comment def-Comment def-Syntax'># check for duplicate email address</span>
1317:       <span class='perl-Comment def-Comment def-Syntax'># insert into the database</span>
1318:       <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>DBIx</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Abstract</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1319:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$db</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBIx</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Abstract</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-WordFun def-FunctionKeyword def-Keyword'>connect</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$DBH</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1320:       <span class='perl-Word def-Keyword'>delete</span> <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>password_confirmation</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1321:       <span class='perl-Comment def-Comment def-Syntax'># XXX There's a good chance we should be verifying email addresses when people sign up. -mls</span>
1322:       <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_state</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'authorized'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1323:       <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>registration_ip</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>REMOTE_ADDR</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1324:       <span class='perl-Var def-Var'>$db</span><span class='perl-Symb def-Symbol'>-></span>insert<span class='def-Symbol'>(</span><span class='perl-String def-String'>'cas_users'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$valid</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1325:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>login_process<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1326:    <span class='def-SymbolStrong def-Symbol'>}</span>
1327:    
1328: <span class='def-SymbolStrong def-Symbol'>}</span>
1329: <span class='perl-Comment def-Comment def-Syntax'># create a hash from Data::FormValidator data for HTML::Template Input</span>
1330: <span class='perl-Comment def-Comment def-Syntax'># is a reference to a list of fields with errors and a hash of field</span>
1331: <span class='perl-Comment def-Comment def-Syntax'># names and custom error message messages</span>
1332: <span class='perl-Comment def-Comment def-Syntax'># output is hash reference for HTML::Template;</span>
1333: <span class='perl-Word def-Keyword'>sub</span> error_marks <span class='def-SymbolStrong def-Symbol'>{</span>
1334:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$missing</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$invalid</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$msgs</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1335:    
1336:    <span class='perl-Comment def-Comment def-Syntax'># set one field just to say "we have some errors"</span>
1337:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$err_h</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-String def-String'>'err__'</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>1</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1338: 
1339:    <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$err</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$missing</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1340:       <span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'Missing'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1341:       <span class='perl-Var def-Var'>$err_h</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'err_'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span>
1342:     <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>ERROR_MARK</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'&lt;B>&lt;font size="-1">'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'&lt;/font>&lt;/B>'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1343:    <span class='def-SymbolStrong def-Symbol'>}</span>
1344:    <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$err</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$invalid</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1345:       <span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'Invalid'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1346:       <span class='perl-Var def-Var'>$err_h</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'err_'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span>
1347:     <span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>ERROR_MARK</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'&lt;B>&lt;font size="-1">'</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-Var def-Var'>$msgs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$err</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>.</span><span class='perl-String def-String'>'&lt;/font>&lt;/B>'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1348:    <span class='def-SymbolStrong def-Symbol'>}</span>
1349:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$err_h</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1350: <span class='def-SymbolStrong def-Symbol'>}</span>
1351: 
1352: <span class='perl-Comment def-Comment def-Syntax'># a general purpose image validation routine</span>
1353: <span class='perl-Comment def-Comment def-Syntax'># input</span>
1354: <span class='perl-Comment def-Comment def-Syntax'>#    1. form field name</span>
1355: <span class='perl-Comment def-Comment def-Syntax'>#    2. hashref of maxes (width, height, bytes)         </span>
1356: <span class='perl-Comment def-Comment def-Syntax'># output: </span>
1357: <span class='perl-Comment def-Comment def-Syntax'>#   1. attribute hash (width, height, mime_type, extension)</span>
1358: <span class='perl-Comment def-Comment def-Syntax'>#   2. error msg (if any)</span>
1359: <span class='perl-Word def-Keyword'>sub</span> validate_image <span class='def-SymbolStrong def-Symbol'>{</span>
1360:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Image</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Size</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1361:    import <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Image</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Size</span> <span class='perl-ReType perl-Word def-Keyword'>qw</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>imgsize</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1362:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTTP::Headers</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-packages-user def-Directive'>UserAgent</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1363:    import <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTTP::Headers</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>UserAgent</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1364:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>File::Basename</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1365:    import <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>File::Basename</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>  
1366: 
1367:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%os_convert</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
1368:       <span class='perl-Var def-Var'>Win95           </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'MSWin32'</span><span class='perl-Symb def-Symbol'>,</span>
1369:       <span class='perl-Var def-Var'>Win98           </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'MSWin32'</span><span class='perl-Symb def-Symbol'>,</span>
1370:       <span class='perl-Var def-Var'>WinNT           </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'MSWin32'</span><span class='perl-Symb def-Symbol'>,</span>
1371:       <span class='perl-Var def-Var'>Mac             </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'MacOS'</span><span class='perl-Symb def-Symbol'>,</span>
1372:       <span class='perl-Var def-Var'>Linux           </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>''</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Comment def-Comment def-Syntax'># the default for File::Basename</span>
1373:       <span class='perl-Var def-Var'>UNIX            </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>''</span>
1374:    <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1375: 
1376:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%valid_mime_types</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
1377:       <span class='perl-String def-String'>'image/jpeg'</span>    <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>,</span>
1378:       <span class='perl-String def-String'>'image/gif'</span>     <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>,</span>
1379:       <span class='perl-String def-String'>'image/png'</span>     <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>1</span><span class='perl-Symb def-Symbol'>,</span>
1380:      <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1381: 
1382:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$field</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1383:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$maxs</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1384:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$img</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>upload<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$field</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1385:    carp <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>cgi_error <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>!</span><span class='perl-Var def-Var'>$img</span> <span class='perl-Symb def-Symbol'>&amp;</span><span class='perl-Symb def-Symbol'>&amp;</span> <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>cgi_error<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1386: 
1387:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$tmp_file</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>tmpFileName<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$field</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1388:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$file_size</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>stat</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$img</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span><span class='def-Symbol'>[</span><span class='perl-Numb def-Number'>7</span><span class='def-Symbol'>]</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1389:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$mime_type</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$q</span><span class='perl-Symb def-Symbol'>-></span>uploadInfo<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$img</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-String def-String'>'Content-Type'</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Word def-Keyword'>if</span> <span class='perl-Var def-Var'>$img</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1390: 
1391:    <span class='perl-Word def-Keyword'>if</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$file_size</span> <span class='perl-Symb def-Symbol'>></span> <span class='perl-Var def-Var'>$maxs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>bytes</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1392:       <span class='perl-Word def-Keyword'>return</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>undef</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>"File size exceeds maximum allowed"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1393:    <span class='def-SymbolStrong def-Symbol'>}</span>
1394:    
1395:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>!</span> <span class='perl-Var def-Var'>$valid_mime_types</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$mime_type</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1396:       <span class='perl-Word def-Keyword'>return</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>undef</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"Does not appear to be an allowed image format. (GIF, JPG, or PNG)"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1397:    <span class='def-SymbolStrong def-Symbol'>}</span> 
1398: 
1399:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$width</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$height</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> imgsize<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$tmp_file</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1400:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$err</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1401:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$width</span> <span class='perl-Symb def-Symbol'>></span> <span class='perl-Var def-Var'>$maxs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>width</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span>
1402:     <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$height</span> <span class='perl-Symb def-Symbol'>></span> <span class='perl-Var def-Var'>$maxs</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>height</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1403:      <span class='perl-Var def-Var'>$err</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"Image dimensions (</span><span class='perl-Var def-Var'>$width</span><span class='perl-String def-String'> x </span><span class='perl-Var def-Var'>$height</span><span class='perl-String def-String'>) exceeds maximum allowed</span>
1404: <span class='perl-String def-String'>           (</span><span class='perl-Var def-Var'>$maxs</span><span class='perl-String def-String'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>width</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'> x </span><span class='perl-Var def-Var'>$maxs</span><span class='perl-String def-String'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>height</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>)"</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1405:    <span class='def-SymbolStrong def-Symbol'>}</span>
1406: 
1407:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$Platform</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>HTTP::Headers</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-Symb def-Symbol'>:</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>UserAgent</span><span class='perl-Symb def-Symbol'>::</span>GetPlatform <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>HTTP_USER_AGENT</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1408:    fileparse_set_fstype<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$os_convert</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>$Platform</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1409:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$orig_file_name</span> <span class='perl-Symb def-Symbol'>=</span> basename<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$img</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1410:    <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$ext</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$orig_file_name</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>m</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-Symbol def-StringContent def-String'>\.</span><span class='regexp-SymbClass def-Var'>\w</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-MetaSymb def-Symbol'>?</span><span class='regexp-MetaSymb def-Symbol'>$</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1411: 
1412:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>%attr</span> <span class='perl-Symb def-Symbol'>=</span> <span class='def-Symbol'>(</span>
1413:      <span class='perl-Var def-Var'>width  </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$width</span><span class='perl-Symb def-Symbol'>,</span>
1414:      <span class='perl-Var def-Var'>height </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$height</span><span class='perl-Symb def-Symbol'>,</span>
1415:      <span class='perl-Var def-Var'>extension </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$ext</span><span class='perl-Symb def-Symbol'>,</span> 
1416:      <span class='perl-Var def-Var'>mime_type </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$mime_type</span><span class='perl-Symb def-Symbol'>,</span>
1417:     <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1418:    <span class='perl-Word def-Keyword'>return</span> <span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%attr</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$err</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1419: <span class='def-SymbolStrong def-Symbol'>}</span>
1420: 
1421: 
1422: <span class='perl-Comment def-Comment def-Syntax'># XXX maybe I should rename this item_comments_view to be more consistent. -mls</span>
1423: <span class='perl-Word def-Keyword'>sub</span> item_view_comments <span class='def-SymbolStrong def-Symbol'>{</span>
1424:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1425:    <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"No item_id"</span><span class='perl-Symb def-Symbol'>,</span>
1426:                        <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Insufficient information was found to build this page'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1427: 
1428:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> 
1429:     <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"No item"</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Failed to create an Item'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1430:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'item-view-comments.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1431:    <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>comments_html<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1432:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1433: <span class='def-SymbolStrong def-Symbol'>}</span>
1434: 
1435: <span class='perl-Word def-Keyword'>sub</span> item_include_comments <span class='def-SymbolStrong def-Symbol'>{</span>
1436:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
1437:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item_id</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$where</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
1438:    
1439:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1440:    <span class='perl-Comment def-Comment def-Syntax'># first we try an explicit item_id</span>
1441:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1442:       <span class='perl-Var def-Var'>$where</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>' item_id = ? '</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1443:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1444:    <span class='def-SymbolStrong def-Symbol'>}</span>
1445:    <span class='perl-Comment def-Comment def-Syntax'># next we try matching the documents URI</span>
1446:    <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1447:       <span class='perl-Var def-Var'>$where</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>'url = ?'</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1448:       <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$ENV</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DOCUMENT_URI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1449:    <span class='def-SymbolStrong def-Symbol'>}</span>
1450: 
1451:    <span class='perl-Var def-Var'>$item_id</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span>
1452:        <span class='perl-String def-String'>"SELECT item_id FROM cas_item_approved WHERE </span><span class='perl-Var def-Var'>$where</span><span class='perl-String def-String'>"</span><span class='perl-Symb def-Symbol'>,</span>
1453:            <span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1454:         <span class='perl-Var def-Var'>@bind</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1455:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item_id</span> <span class='perl-Symb def-Symbol'>></span> <span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1456:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$item</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Item</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$item_id</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1457:       <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'includes/item-include-comments.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1458:       <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$item</span><span class='perl-Symb def-Symbol'>-></span>comments_html<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1459:       <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1460:    <span class='def-SymbolStrong def-Symbol'>}</span>
1461: 
1462: <span class='def-SymbolStrong def-Symbol'>}</span>
1463: 
1464: 
1465: <span class='perl-Word def-Keyword'>sub</span> item_comment_post <span class='def-SymbolStrong def-Symbol'>{</span>
1466:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1467:    <span class='perl-Comment def-Comment def-Syntax'># validate the form;</span>
1468:    <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Technical Failure'</span><span class='perl-Symb def-Symbol'>,</span>
1469:                        <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'No item_id was found. This is probably not your fault'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1470: 
1471:    <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Not logged in'</span><span class='perl-Symb def-Symbol'>,</span>
1472:                       <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'You need to logged in for this function to work. </span>
1473: <span class='perl-String def-String'>         Try going back and reloading the page'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1474: 
1475:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>Data</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>FormValidator</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1476:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$validator</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Data</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>FormValidator</span><span class='perl-Symb def-Symbol'>-></span>new<span class='def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>{</span>
1477:       <span class='perl-Var def-Var'>form </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-SymbolStrong def-Symbol'>{</span>
1478:        <span class='perl-Var def-Var'>optional </span><span class='perl-Symb def-Symbol'>=></span> <span class='def-Symbol'>[</span><span class='perl-ReType perl-Word def-Keyword'>qw</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>rating comment</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='def-Symbol'>]</span><span class='perl-Symb def-Symbol'>,</span>
1479:        <span class='perl-Var def-Var'>filters </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>'trim'</span><span class='perl-Symb def-Symbol'>,</span>
1480:     <span class='def-SymbolStrong def-Symbol'>}</span>
1481:      <span class='def-SymbolStrong def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1482:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$valid</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$validator</span><span class='perl-Symb def-Symbol'>-></span>validate<span class='def-Symbol'>(</span><span class='perl-Symb def-Symbol'>\</span><span class='perl-Var def-Var'>%FORM</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>'form'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1483: 
1484:    <span class='perl-Comment def-Comment def-Syntax'># throw an error if they don't give a rating or a comment</span>
1485:    <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rating</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>comment</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span>
1486:      <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Insufficient Information'</span><span class='perl-Symb def-Symbol'>,</span>
1487:         <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'You must supply a rating and/or a comment.'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1488: 
1489:    <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1490:    <span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1491: 
1492:    <span class='perl-Word def-Keyword'>require</span> <span class='perl-packages-user def-Directive'>DBIx</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages-user def-Directive'>Abstract</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1493:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$db</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBIx</span><span class='perl-Symb def-Symbol'>::</span><span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Abstract</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-WordFun def-FunctionKeyword def-Keyword'>connect</span><span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$DBH</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1494:    <span class='perl-Comment def-Comment def-Syntax'># If they've already posted</span>
1495:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
1496: <span class='perl-String def-String'>          SELECT </span><span class='def-NumberDec def-Number'>1</span><span class='perl-String def-String'> FROM cas_user_item_map</span>
1497: <span class='perl-String def-String'>              WHERE user_id = ? AND item_id = ?"</span>
1498:               <span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1499: 
1500:       <span class='perl-Var def-Var'>$db</span><span class='perl-Symb def-Symbol'>-></span>update<span class='def-Symbol'>(</span><span class='perl-String def-String'>'cas_user_item_map'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$valid</span><span class='perl-Symb def-Symbol'>,</span>
1501:           <span class='def-SymbolStrong def-Symbol'>{</span> <span class='perl-Var def-Var'>user_id </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>item_id </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='def-SymbolStrong def-Symbol'>}</span><span class='def-Symbol'>)</span>
1502:    <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1503:       <span class='perl-Var def-Var'>$db</span><span class='perl-Symb def-Symbol'>-></span>insert<span class='def-Symbol'>(</span><span class='perl-String def-String'>'cas_user_item_map'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$valid</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1504:    <span class='def-SymbolStrong def-Symbol'>}</span>
1505:   
1506:    <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBI</span><span class='perl-Symb def-Symbol'>-></span>trace<span class='def-Symbol'>(</span><span class='perl-Numb def-Number'>1</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1507:    <span class='perl-Comment def-Comment def-Syntax'># write affected static pages if we need to. </span>
1508:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>DYNAMIC_ONLY_P</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1509:        <span class='perl-Comment def-Comment def-Syntax'># write static pages for all affected categories</span>
1510:        <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat_ids</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectcol_arrayref<span class='def-Symbol'>(</span><span class='perl-String def-String'>"</span>
1511: <span class='perl-String def-String'>       SELECT category_id </span>
1512: <span class='perl-String def-String'>       FROM cas_category cat</span>
1513: <span class='perl-String def-String'>       LEFT JOIN cas_category_item_map map USING (category_id)</span>
1514: <span class='perl-String def-String'>       WHERE map.item_id = ?"</span><span class='perl-Symb def-Symbol'>,</span>
1515:        <span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1516: 
1517:        <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$id</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@$cat_ids</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1518:            <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span>Category<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$id</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>mode</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'static'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1519:            <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$rv</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>write_static_cat<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>verbose</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1520:        <span class='def-SymbolStrong def-Symbol'>}</span>
1521:    <span class='def-SymbolStrong def-Symbol'>}</span>
1522:    <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>DBI</span><span class='perl-Symb def-Symbol'>-></span>trace<span class='def-Symbol'>(</span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1523: 
1524:    <span class='perl-Comment def-Comment def-Syntax'># Send comments to those who care </span>
1525:    <span class='perl-Comment def-Comment def-Syntax'># XXX For now, just admins. Later, maybe editors, too </span>
1526:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$cat</span> <span class='perl-Symb def-Symbol'>=</span> new <span class='perl-packages perl-WordExt def-KeywordStrong def-Keyword'>Cascade</span><span class='perl-Symb def-Symbol'>::</span>Category<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>id</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Numb def-Number'>0</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1527:       <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$to_emails</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$cat</span><span class='perl-Symb def-Symbol'>-></span>get_admin_and_cat_emails<span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1528:      <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'emails/item-alert-comment.txt'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1529:      <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span>
1530:         <span class='perl-Var def-Var'>to_emails   </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$to_emails</span><span class='perl-Symb def-Symbol'>,</span>
1531:         <span class='perl-Var def-Var'>from_email     </span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1532:         <span class='perl-Var def-Var'>title     </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1533:         <span class='perl-Var def-Var'>rating    </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>rating</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1534:         <span class='perl-Var def-Var'>comment     </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>comment</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span>
1535:         <span class='perl-Var def-Var'>comment_url </span><span class='perl-Symb def-Symbol'>=></span> <span class='perl-String def-String'>"</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/item_view_comments?item_id=</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>"</span><span class='perl-Symb def-Symbol'>,</span>
1536:         <span class='perl-Var def-Var'>delete_url  </span><span class='perl-Symb def-Symbol'>=></span>
1537:           <span class='perl-String def-String'>"</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/item_comments_delete?item_id=</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>&amp;comment_delete=</span><span class='perl-Var def-Var'>$SES</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>"</span><span class='perl-Symb def-Symbol'>,</span>
1538:           
1539:        <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1540:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>open</span><span class='def-Symbol'>(</span>MAIL<span class='perl-Symb def-Symbol'>,</span> <span class='perl-String def-String'>"|</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>MAILPROG</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'> -t"</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Word def-Keyword'>return</span> 
1541:        err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Error Opening Mail Program'</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There was an error opening the mail program'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1542:      <span class='perl-Word def-Keyword'>eval</span> <span class='def-SymbolStrong def-Symbol'>{</span><span class='perl-Word def-Keyword'>print</span> MAIL <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output <span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1543:      <span class='perl-Var def-Var'>$@</span> <span class='perl-Symb def-Symbol'>and</span> carp <span class='perl-Var def-Var'>$@</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> 
1544:      <span class='perl-WordFun def-FunctionKeyword def-Keyword'>close</span><span class='def-Symbol'>(</span>MAIL<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1545:        <span class='def-SymbolStrong def-Symbol'>}</span>
1546: 
1547:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_view_comments<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1548: 
1549: <span class='def-SymbolStrong def-Symbol'>}</span>
1550: 
1551: <span class='perl-Word def-Keyword'>sub</span> item_comments_delete <span class='def-SymbolStrong def-Symbol'>{</span>
1552:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1553:    <span class='perl-Word def-Keyword'>length</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> error<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"Insufficient Information"</span><span class='perl-Symb def-Symbol'>,</span>
1554:                   <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"No item_id was found"</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1555: 
1556:    <span class='perl-Comment def-Comment def-Syntax'># delete the marked comments</span>
1557:    <span class='perl-Word def-Keyword'>foreach</span> <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$c</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>query<span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span><span class='perl-String def-String'>'comment_delete'</span><span class='def-Symbol'>)</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1558:       <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span><span class='perl-Word def-Keyword'>do</span><span class='def-Symbol'>(</span><span class='perl-String def-String'>"DELETE FROM cas_user_item_map</span>
1559: <span class='perl-String def-String'>         WHERE item_id = ?</span>
1560: <span class='perl-String def-String'>           AND user_id = ? "</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>item_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$c</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1561:    <span class='def-SymbolStrong def-Symbol'>}</span>
1562: 
1563:    <span class='perl-Comment def-Comment def-Syntax'># return to the page</span>
1564:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>item_view_comments<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1565: <span class='def-SymbolStrong def-Symbol'>}</span>
1566: 
1567: <span class='perl-Word def-Keyword'>sub</span> password_forgot_form <span class='def-SymbolStrong def-Symbol'>{</span>
1568:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1569:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'register-forgot-password.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1570:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1571: <span class='def-SymbolStrong def-Symbol'>}</span>
1572: 
1573: <span class='perl-Word def-Keyword'>sub</span> password_mail_success <span class='def-SymbolStrong def-Symbol'>{</span>
1574:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1575:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$t</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'register-password-emailed.tmpl'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1576:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$t</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1577: <span class='def-SymbolStrong def-Symbol'>}</span>
1578: 
1579: <span class='perl-Word def-Keyword'>sub</span> password_mail_forgotten <span class='def-SymbolStrong def-Symbol'>{</span>
1580:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$self</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1581: 
1582:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span> <span class='perl-Symb def-Symbol'>or</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1583:     <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Insufficient Information'</span><span class='perl-Symb def-Symbol'>,</span>
1584:         <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'There was an error processing your request-- Insufficient Information was received'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1585:      <span class='def-SymbolStrong def-Symbol'>}</span>
1586: 
1587:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@bind</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1588:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>"SELECT password,email FROM cas_users WHERE "</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1589:    <span class='perl-Word def-Keyword'>if</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1590:         <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>" user_id = ? "</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1591:         <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>user_id</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1592:    <span class='def-SymbolStrong def-Symbol'>}</span> <span class='perl-Word def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1593:        <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>.</span><span class='perl-Symb def-Symbol'>=</span> <span class='perl-String def-String'>" lower(email) = ? "</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1594:        <span class='perl-WordFun def-FunctionKeyword def-Keyword'>push</span> <span class='perl-Var def-Var'>@bind</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Word def-Keyword'>lc</span> <span class='perl-Var def-Var'>$FORM</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1595:    <span class='def-SymbolStrong def-Symbol'>}</span>
1596:    <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$password</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>$email</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>selectrow_array<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$sql</span><span class='perl-Symb def-Symbol'>,</span><span class='def-SymbolStrong def-Symbol'>{</span><span class='def-SymbolStrong def-Symbol'>}</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>@bind</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1597: 
1598:    <span class='perl-Word def-Keyword'>unless</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$password</span> <span class='perl-Symb def-Symbol'>and</span> <span class='perl-Var def-Var'>$email</span><span class='def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
1599:           <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Information not found'</span><span class='perl-Symb def-Symbol'>,</span>
1600:         <span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-ReType perl-Word def-Keyword'>qq</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span><span class='perl-String def-String'>We could not find sufficient information on your account.</span>
1601: <span class='perl-String def-String'>            &lt;P></span>
1602: <span class='perl-String def-String'>            Return to our &lt;A HREF="</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CASCADE_CGI</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'>/login">login page&lt;/A> to try logging in again</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>!</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1603:    <span class='def-SymbolStrong def-Symbol'>}</span>
1604: 
1605:    <span class='perl-WordFun def-FunctionKeyword def-Keyword'>open</span><span class='def-Symbol'>(</span>MAIL<span class='perl-Symb def-Symbol'>,</span><span class='perl-String def-String'>"|</span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>MAILPROG</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'> -t "</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>|</span><span class='perl-Symb def-Symbol'>|</span> <span class='perl-Word def-Keyword'>return</span> err<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>title</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>'Error sending email'</span><span class='perl-Symb def-Symbol'>,</span><span class='perl-Var def-Var'>msg</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-String def-String'>"There was an error sending the message,</span>
1606: <span class='perl-String def-String'>            please contact </span><span class='perl-Var def-Var'>$CFG</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>CONTACT_EMAIL</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-String def-String'> for assistance."</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1607:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$msg</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>load_tmpl<span class='def-Symbol'>(</span><span class='perl-String def-String'>'emails/password-forgot.txt'</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1608:    <span class='perl-Var def-Var'>$msg</span><span class='perl-Symb def-Symbol'>-></span>param<span class='def-Symbol'>(</span> <span class='perl-Var def-Var'>email</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$email</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>password</span><span class='perl-Symb def-Symbol'>=></span><span class='perl-Var def-Var'>$password</span> <span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1609:    <span class='perl-Word def-Keyword'>print</span> MAIL <span class='perl-Var def-Var'>$msg</span><span class='perl-Symb def-Symbol'>-></span>output<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1610:    <span class='perl-WordFun def-FunctionKeyword def-Keyword'>close</span><span class='def-Symbol'>(</span>MAIL<span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1611: 
1612:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$self</span><span class='perl-Symb def-Symbol'>-></span>password_mail_success<span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1613: <span class='def-SymbolStrong def-Symbol'>}</span>
1614: 
1615: <span class='perl-Comment def-Comment def-Syntax'># make text a little more readable as HTML</span>
1616: <span class='perl-Word def-Keyword'>sub</span> htmlicize <span class='def-SymbolStrong def-Symbol'>{</span>
1617:    <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$txt</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>shift</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1618:    <span class='perl-Comment def-Comment def-Syntax'># convert 2 or more blank lines to a paragraph break</span>
1619:    <span class='perl-Var def-Var'>$txt</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>(</span><span class='regexp-SymbClass def-Var'>\s</span><span class='regexp-MetaSymb def-Symbol'>*</span><span class='regexp-Symbol def-StringContent def-String'>\n</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>)</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>{</span><span class='def-Number'>2</span><span class='regexp-Quote regexp-MetaSymb def-Symbol'>}</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>&lt;P></span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>gsi</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1620: 
1621:    <span class='perl-Comment def-Comment def-Syntax'># convert remaining newlines to html line breaks</span>
1622:    <span class='perl-Var def-Var'>$txt</span> <span class='perl-Symb def-Symbol'>=</span><span class='perl-Symb def-Symbol'>~</span> <span class='perl-ReType perl-Word def-Keyword'>s</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='regexp-Symbol def-StringContent def-String'>\n</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-String def-String'>&lt;BR></span><span class='regexp-Symbol def-StringContent def-String'>\n</span><span class='perl-StringEdge regexp-SpecQuote def-StringEdge def-String'>/</span><span class='perl-ReModif regexp-SpecArea def-Keyword'>gsi</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1623: 
1624:    <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$txt</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1625: <span class='def-SymbolStrong def-Symbol'>}</span>
1626: 
1627: <span class='perl-Comment def-Comment def-Syntax'># We use this sometimes to avoid the overhead of DBIx::Abstract</span>
1628: <span class='perl-Comment def-Comment def-Syntax'># and take advantage of prepare_cached for mass inserting</span>
1629: <span class='perl-Comment def-Comment def-Syntax'># (which only happened for a bookmark import script when I added this. -mls )</span>
1630: <span class='perl-Comment def-Comment def-Syntax'># credit: This is basically straight from the DBI documentation. </span>
1631: <span class='perl-Word def-Keyword'>sub</span> insert_hash <span class='def-SymbolStrong def-Symbol'>{</span>
1632:     <span class='perl-Word def-Keyword'>my</span> <span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$table</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>$field_values</span><span class='def-Symbol'>)</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@_</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1633:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@fields</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>sort</span> <span class='perl-Word def-Keyword'>keys</span> <span class='perl-Var def-Var'>%$field_values</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span> <span class='perl-Comment def-Comment def-Syntax'># sort required</span>
1634:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>@values</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>@</span><span class='perl-Var def-Var'>{</span><span class='perl-Var def-Var'>$field_values</span><span class='perl-Var def-Var'>}</span><span class='perl-Symb def-Symbol'>{</span><span class='perl-Var def-Var'>@fields</span><span class='perl-Symb def-Symbol'>}</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1635:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$sql</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-WordFun def-FunctionKeyword def-Keyword'>sprintf</span> <span class='perl-String def-String'>"insert into </span><span class='perl-Var2 def-VarStrong def-Var'>%s</span><span class='perl-String def-String'> (</span><span class='perl-Var2 def-VarStrong def-Var'>%s</span><span class='perl-String def-String'>) values (</span><span class='perl-Var2 def-VarStrong def-Var'>%s</span><span class='perl-String def-String'>)"</span><span class='perl-Symb def-Symbol'>,</span>
1636:         <span class='perl-Var def-Var'>$table</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Word def-Keyword'>join</span><span class='def-Symbol'>(</span><span class='perl-String def-String'>","</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Var def-Var'>@fields</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>,</span> <span class='perl-Word def-Keyword'>join</span><span class='def-Symbol'>(</span><span class='perl-String def-String'>","</span><span class='perl-Symb def-Symbol'>,</span> <span class='def-Symbol'>(</span><span class='perl-String def-String'>"?"</span><span class='def-Symbol'>)</span><span class='perl-Symb def-Symbol'>x</span><span class='perl-Var def-Var'>@fields</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1637:     <span class='perl-Word def-Keyword'>my</span> <span class='perl-Var def-Var'>$sth</span> <span class='perl-Symb def-Symbol'>=</span> <span class='perl-Var def-Var'>$DBH</span><span class='perl-Symb def-Symbol'>-></span>prepare_cached<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>$sql</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1638:     <span class='perl-Word def-Keyword'>return</span> <span class='perl-Var def-Var'>$sth</span><span class='perl-Symb def-Symbol'>-></span>execute<span class='def-Symbol'>(</span><span class='perl-Var def-Var'>@values</span><span class='def-Symbol'>)</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1639: <span class='def-SymbolStrong def-Symbol'>}</span>
1640: 
1641: <span class='perl-Numb def-Number'>1</span><span class='perl-MainSymb def-SymbolStrong def-Symbol'>;</span>
1642: 
1643: 
1644: 
