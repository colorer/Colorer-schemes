  0: <span class='modula2-Keyword def-Keyword'>MODULE</span> ovl<span class='modula2-Symbol def-Symbol'>;</span>
  1: <span class='modula2-Comment def-Comment def-Syntax'>(* Copyright (C) 1987 Jensen &amp; Partners International *)</span>
  2: <span class='modula2-Keyword def-Keyword'>IMPORT</span> Lib<span class='modula2-Symbol def-Symbol'>,</span>Str<span class='modula2-Symbol def-Symbol'>,</span>FIO<span class='modula2-Symbol def-Symbol'>,</span>IO<span class='modula2-Symbol def-Symbol'>,</span>Storage<span class='modula2-Symbol def-Symbol'>;</span>
  3: 
  4: <span class='modula2-Keyword def-Keyword'>CONST</span>
  5:   MaxOverlay <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>9</span><span class='modula2-Symbol def-Symbol'>;</span>
  6: 
  7: <span class='modula2-Keyword def-Keyword'>TYPE</span>
  8:   String <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..99</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
  9: 
 10:   tUnit <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Symbol def-Symbol'>RECORD</span>
 11:      Name<span class='modula2-Symbol def-Symbol'>:</span>String<span class='modula2-Symbol def-Symbol'>;</span>
 12:      Start<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
 13:      StartSeg<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* == CARDINAL(Start DIV 16) *)</span>
 14:      Diff<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* in paras between new and old position *)</span>
 15:      Overlay<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..</span>MaxOverlay<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>;</span>
 16:      UnitPadding<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1..128</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Symbol def-Symbol'>(</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>String<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>4</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>2</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>2</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>2</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>BYTE</span><span class='modula2-Symbol def-Symbol'>;</span>
 17:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 18: 
 19:   tfix<span class='modula2-Symbol def-Symbol'>=</span><span class='modula2-Symbol def-Symbol'>RECORD</span>
 20:      locoff<span class='modula2-Symbol def-Symbol'>:</span>SHORTCARD<span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* high 4 bits = overlay number *)</span>
 21:      locseg<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 22:      target<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 23:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 24: 
 25:   texeheader <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Symbol def-Symbol'>RECORD</span>
 26:     magic <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 27:     sizemod512 <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 28:     sizediv512 <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 29:     numrelocitem <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 30:     headerparas <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 31:     heapminparas <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 32:     heapmaxparas <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 33:     initialss <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 34:     initialsp <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 35:     checksum <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 36:     initialip <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 37:     initialcs <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 38:     relocations <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 39:     ovrlay <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 40:     undocumented <span class='modula2-Symbol def-Symbol'>:</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 41:     <span class='modula2-Comment def-Comment def-Syntax'>(* relocation items follow *)</span>
 42:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 43: 
 44:   Str4 <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Keyword def-Keyword'>ARRAY</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..3</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span> <span class='modula2-Symbol def-Symbol'>;</span>
 45: 
 46: 
 47: <span class='modula2-Keyword def-Keyword'>VAR</span>
 48:   exefile<span class='modula2-Symbol def-Symbol'>,</span>exefile1<span class='modula2-Symbol def-Symbol'>,</span>mapfile<span class='modula2-Symbol def-Symbol'>,</span>ovlfile<span class='modula2-Symbol def-Symbol'>,</span>newmapfile<span class='modula2-Symbol def-Symbol'>:</span>FIO<span class='modula2-Number def-Number'>.</span>File<span class='modula2-Symbol def-Symbol'>;</span>
 49: 
 50:   nmap<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 51:   map<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1..300</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> tUnit<span class='modula2-Symbol def-Symbol'>;</span>
 52: 
 53:   ovlheaders<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..</span>MaxOverlay<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='modula2-Symbol def-Symbol'>RECORD</span>
 54:     Alloc<span class='modula2-Symbol def-Symbol'>:</span>   LONGCARD<span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* total size *)</span>
 55:     Init<span class='modula2-Symbol def-Symbol'>:</span>    LONGCARD<span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* size of initialised part *)</span>
 56:     nifix<span class='modula2-Symbol def-Symbol'>:</span>   <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 57:     nefix<span class='modula2-Symbol def-Symbol'>:</span>   <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 58:     copyr<span class='modula2-Symbol def-Symbol'>:</span>   Str4 <span class='modula2-Symbol def-Symbol'>;</span>    <span class='modula2-Comment def-Comment def-Syntax'>(* used for checking overlay version *)</span>
 59:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 60: 
 61:   ovlfiles<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..</span>MaxOverlay<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 62: 
 63: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> GiveBuf<span class='modula2-Symbol def-Symbol'>(</span> f<span class='modula2-Symbol def-Symbol'>:</span>FIO<span class='modula2-Number def-Number'>.</span>File <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 64: <span class='modula2-Keyword def-Keyword'>TYPE</span> buf <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..517</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>BYTE</span><span class='modula2-Symbol def-Symbol'>;</span>
 65: <span class='modula2-Keyword def-Keyword'>VAR</span> bufp <span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>POINTER</span> <span class='modula2-Keyword def-Keyword'>TO</span> buf<span class='modula2-Symbol def-Symbol'>;</span>
 66: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
 67:   Storage<span class='modula2-Number def-Number'>.</span>ALLOCATE<span class='modula2-Symbol def-Symbol'>(</span>bufp<span class='modula2-Symbol def-Symbol'>,</span>SIZE<span class='modula2-Symbol def-Symbol'>(</span>buf<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 68:   FIO<span class='modula2-Number def-Number'>.</span>AssignBuffer<span class='modula2-Symbol def-Symbol'>(</span>f<span class='modula2-Symbol def-Symbol'>,</span>bufp<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 69: <span class='modula2-Symbol def-Symbol'>END</span> GiveBuf<span class='modula2-Symbol def-Symbol'>;</span>
 70: 
 71: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> ReadHex<span class='modula2-Symbol def-Symbol'>(</span>s<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>BYTE</span><span class='modula2-Symbol def-Symbol'>;</span>i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
 72: <span class='modula2-Keyword def-Keyword'>VAR</span> res<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span> c<span class='modula2-Symbol def-Symbol'>:</span>SHORTCARD<span class='modula2-Symbol def-Symbol'>;</span>
 73: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
 74:   res <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
 75:   <span class='modula2-Symbol def-Symbol'>LOOP</span>
 76:     c <span class='modula2-Symbol def-Symbol'>:=</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>(</span>s<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 77:     INC<span class='modula2-Symbol def-Symbol'>(</span>i<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 78:     <span class='modula2-Symbol def-Symbol'>CASE</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span>c<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>OF</span>
 79:       <span class='modula2-String def-String'>'A'</span><span class='modula2-Symbol def-Symbol'>.</span><span class='modula2-Symbol def-Symbol'>.</span><span class='modula2-String def-String'>'F'</span><span class='modula2-Symbol def-Symbol'>:</span> c <span class='modula2-Symbol def-Symbol'>:=</span> c <span class='modula2-Symbol def-Symbol'>-</span> <span class='modula2-Symbol def-Symbol'>(</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'A'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>-</span> <span class='modula2-Number def-Number'>10</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
 80:     <span class='modula2-Symbol def-Symbol'>|</span> <span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>.</span><span class='modula2-Symbol def-Symbol'>.</span><span class='modula2-String def-String'>'9'</span><span class='modula2-Symbol def-Symbol'>:</span> c <span class='modula2-Symbol def-Symbol'>:=</span> c <span class='modula2-Symbol def-Symbol'>-</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 81:     <span class='modula2-Keyword def-Keyword'>ELSE</span> <span class='modula2-Keyword def-Keyword'>EXIT</span><span class='modula2-Symbol def-Symbol'>;</span>
 82:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 83:     res <span class='modula2-Symbol def-Symbol'>:=</span> res <span class='modula2-Symbol def-Symbol'>*</span> <span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>+</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span> c <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
 84:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
 85:   <span class='modula2-Keyword def-Keyword'>RETURN</span> res<span class='modula2-Symbol def-Symbol'>;</span>
 86: <span class='modula2-Symbol def-Symbol'>END</span> ReadHex<span class='modula2-Symbol def-Symbol'>;</span>
 87: 
 88: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> ReadMap<span class='modula2-Symbol def-Symbol'>;</span>
 89: <span class='modula2-Keyword def-Keyword'>CONST</span>
 90:   delim <span class='modula2-Symbol def-Symbol'>=</span> Str<span class='modula2-Number def-Number'>.</span>CHARSET<span class='modula2-Symbol def-Symbol'>{</span><span class='modula2-String def-String'>' '</span><span class='modula2-Symbol def-Symbol'>}</span><span class='modula2-Symbol def-Symbol'>;</span>
 91: <span class='modula2-Keyword def-Keyword'>VAR</span>
 92:   done<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>BOOLEAN</span><span class='modula2-Symbol def-Symbol'>;</span> i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
 93:   sname<span class='modula2-Symbol def-Symbol'>,</span>gname<span class='modula2-Symbol def-Symbol'>,</span>token<span class='modula2-Symbol def-Symbol'>,</span>line<span class='modula2-Symbol def-Symbol'>:</span>String<span class='modula2-Symbol def-Symbol'>;</span>
 94:   start<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
 95: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
 96:   nmap <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
 97:   <span class='modula2-Symbol def-Symbol'>REPEAT</span>
 98:     FIO<span class='modula2-Number def-Number'>.</span>RdStr<span class='modula2-Symbol def-Symbol'>(</span>mapfile<span class='modula2-Symbol def-Symbol'>,</span>line<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
 99:   <span class='modula2-Symbol def-Symbol'>UNTIL</span> <span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span><span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>>=</span><span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>&lt;=</span><span class='modula2-String def-String'>'9'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
100:   <span class='modula2-Symbol def-Symbol'>LOOP</span>
101:   <span class='modula2-Comment def-Comment def-Syntax'>(*  IO.WrStr(line);IO.WrLn; *)</span>
102:     <span class='modula2-Symbol def-Symbol'>IF</span> Str<span class='modula2-Number def-Number'>.</span>Length<span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>&lt;</span> <span class='modula2-Number def-Number'>60</span> <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>EXIT</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
103: 
104:     Str<span class='modula2-Number def-Number'>.</span>Item<span class='modula2-Symbol def-Symbol'>(</span> token<span class='modula2-Symbol def-Symbol'>,</span> line<span class='modula2-Symbol def-Symbol'>,</span> delim<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
105:     start <span class='modula2-Symbol def-Symbol'>:=</span> ReadHex<span class='modula2-Symbol def-Symbol'>(</span> token<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
106: 
107:     Str<span class='modula2-Number def-Number'>.</span>Item<span class='modula2-Symbol def-Symbol'>(</span> sname<span class='modula2-Symbol def-Symbol'>,</span> line<span class='modula2-Symbol def-Symbol'>,</span> delim<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>3</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
108: 
109:     Str<span class='modula2-Number def-Number'>.</span>Item<span class='modula2-Symbol def-Symbol'>(</span> gname<span class='modula2-Symbol def-Symbol'>,</span> line<span class='modula2-Symbol def-Symbol'>,</span> delim<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>5</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
110: 
111:     <span class='modula2-Symbol def-Symbol'>IF</span> <span class='modula2-Symbol def-Symbol'>(</span> Str<span class='modula2-Number def-Number'>.</span>Compare<span class='modula2-Symbol def-Symbol'>(</span>gname<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-String def-String'>'(none)'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
112:       gname <span class='modula2-Symbol def-Symbol'>:=</span> sname<span class='modula2-Symbol def-Symbol'>;</span>
113:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
114: 
115:     <span class='modula2-Symbol def-Symbol'>IF</span> <span class='modula2-Symbol def-Symbol'>(</span> nmap <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span>
116:     <span class='modula2-Keyword def-Keyword'>OR</span> <span class='modula2-Symbol def-Symbol'>(</span> Str<span class='modula2-Number def-Number'>.</span>Compare<span class='modula2-Symbol def-Symbol'>(</span>gname<span class='modula2-Symbol def-Symbol'>,</span>map<span class='modula2-Symbol def-Symbol'>[</span>nmap<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Name<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span>
117:     <span class='modula2-Keyword def-Keyword'>THEN</span>
118:       INC<span class='modula2-Symbol def-Symbol'>(</span>nmap<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
119:       <span class='modula2-Symbol def-Symbol'>WITH</span> map<span class='modula2-Symbol def-Symbol'>[</span>nmap<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
120:         Name <span class='modula2-Symbol def-Symbol'>:=</span> gname<span class='modula2-Symbol def-Symbol'>;</span>
121:         Start <span class='modula2-Symbol def-Symbol'>:=</span> start<span class='modula2-Symbol def-Symbol'>;</span>
122:         StartSeg <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>start <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
123:         Overlay <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
124:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
125:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
126:     FIO<span class='modula2-Number def-Number'>.</span>RdStr<span class='modula2-Symbol def-Symbol'>(</span>mapfile<span class='modula2-Symbol def-Symbol'>,</span>line<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
127:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
128:   map<span class='modula2-Symbol def-Symbol'>[</span>nmap<span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> map<span class='modula2-Symbol def-Symbol'>[</span>nmap<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* sentinel *)</span>
129: <span class='modula2-Symbol def-Symbol'>END</span> ReadMap<span class='modula2-Symbol def-Symbol'>;</span>
130: 
131: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> too_small_check<span class='modula2-Symbol def-Symbol'>;</span>
132: <span class='modula2-Keyword def-Keyword'>VAR</span> i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
133: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
134:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>TO</span> nmap<span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>DO</span>
135:     <span class='modula2-Symbol def-Symbol'>IF</span> <span class='modula2-Symbol def-Symbol'>(</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>StartSeg <span class='modula2-Symbol def-Symbol'>=</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>StartSeg <span class='modula2-Symbol def-Symbol'>)</span>
136:     <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
137:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Name<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
138:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>' too small !!'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
139:       IO<span class='modula2-Number def-Number'>.</span>WrLn<span class='modula2-Symbol def-Symbol'>;</span>
140:       HALT<span class='modula2-Symbol def-Symbol'>;</span>
141:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
142:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
143: <span class='modula2-Symbol def-Symbol'>END</span> too_small_check<span class='modula2-Symbol def-Symbol'>;</span>
144: 
145: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> ReadOvl<span class='modula2-Symbol def-Symbol'>;</span>
146: <span class='modula2-Keyword def-Keyword'>VAR</span> c<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
147: 
148:   <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> nextc<span class='modula2-Symbol def-Symbol'>;</span>
149:   <span class='modula2-Symbol def-Symbol'>BEGIN</span>
150:     c <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>RdChar<span class='modula2-Symbol def-Symbol'>(</span>ovlfile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
151:   <span class='modula2-Symbol def-Symbol'>END</span> nextc<span class='modula2-Symbol def-Symbol'>;</span>
152: 
153: <span class='modula2-Keyword def-Keyword'>VAR</span>
154:     ovln<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
155:     name<span class='modula2-Symbol def-Symbol'>:</span>String<span class='modula2-Symbol def-Symbol'>;</span>
156:     i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
157: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
158:   <span class='modula2-Symbol def-Symbol'>LOOP</span>
159:     <span class='modula2-Symbol def-Symbol'>LOOP</span>
160:       nextc<span class='modula2-Symbol def-Symbol'>;</span>
161:       <span class='modula2-Symbol def-Symbol'>WHILE</span> c <span class='modula2-Symbol def-Symbol'>&lt;=</span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Keyword def-Keyword'>DO</span>
162:         <span class='modula2-Symbol def-Symbol'>IF</span> c <span class='modula2-Symbol def-Symbol'>=</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Number def-Number'>1AH</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>EXIT</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
163:         nextc<span class='modula2-Symbol def-Symbol'>;</span>
164:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
165:       <span class='modula2-Symbol def-Symbol'>IF</span> c <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>';'</span> <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Comment def-Comment def-Syntax'>(* comment *)</span>
166:         <span class='modula2-Symbol def-Symbol'>WHILE</span> c <span class='modula2-Symbol def-Symbol'>>=</span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Keyword def-Keyword'>DO</span> nextc <span class='modula2-Symbol def-Symbol'>END</span> <span class='modula2-Symbol def-Symbol'>;</span>
167:       <span class='modula2-Keyword def-Keyword'>ELSE</span>
168:         <span class='modula2-Keyword def-Keyword'>EXIT</span> <span class='modula2-Symbol def-Symbol'>;</span>
169:       <span class='modula2-Symbol def-Symbol'>END</span> <span class='modula2-Symbol def-Symbol'>;</span>
170:     <span class='modula2-Symbol def-Symbol'>END</span> <span class='modula2-Symbol def-Symbol'>;</span>
171:     <span class='modula2-Symbol def-Symbol'>IF</span> c <span class='modula2-Symbol def-Symbol'>=</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Number def-Number'>1AH</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>EXIT</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
172: 
173:     ovln <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
174: 
175:     <span class='modula2-Symbol def-Symbol'>WHILE</span> <span class='modula2-Symbol def-Symbol'>(</span> c <span class='modula2-Symbol def-Symbol'>>=</span> <span class='modula2-String def-String'>'0'</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> c <span class='modula2-Symbol def-Symbol'>&lt;=</span> <span class='modula2-String def-String'>'9'</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DO</span>
176:       ovln <span class='modula2-Symbol def-Symbol'>:=</span> ovln<span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>10</span> <span class='modula2-Symbol def-Symbol'>+</span> ORD<span class='modula2-Symbol def-Symbol'>(</span>c<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>-</span> ORD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
177:       nextc<span class='modula2-Symbol def-Symbol'>;</span>
178:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
179: 
180:     <span class='modula2-Symbol def-Symbol'>WHILE</span> c <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Keyword def-Keyword'>DO</span> nextc <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
181: 
182:     i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
183:     <span class='modula2-Symbol def-Symbol'>WHILE</span> <span class='modula2-Symbol def-Symbol'>(</span> c <span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DO</span>
184:       name<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> c<span class='modula2-Symbol def-Symbol'>;</span>
185:       INC<span class='modula2-Symbol def-Symbol'>(</span>i<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
186:       nextc<span class='modula2-Symbol def-Symbol'>;</span>
187:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
188:     name<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
189: 
190:     <span class='modula2-Comment def-Comment def-Syntax'>(* search table *)</span>
191:     i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
192:     <span class='modula2-Symbol def-Symbol'>LOOP</span>
193:       INC<span class='modula2-Symbol def-Symbol'>(</span>i<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
194:       <span class='modula2-Symbol def-Symbol'>IF</span> i <span class='modula2-Symbol def-Symbol'>></span> nmap <span class='modula2-Keyword def-Keyword'>THEN</span>
195:         IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'Segment/group name '</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
196:         IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span>name<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
197:         IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>' not found'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
198:         IO<span class='modula2-Number def-Number'>.</span>WrLn<span class='modula2-Symbol def-Symbol'>;</span>
199:         <span class='modula2-Keyword def-Keyword'>EXIT</span><span class='modula2-Symbol def-Symbol'>;</span>
200:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
201:       <span class='modula2-Symbol def-Symbol'>WITH</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
202:         <span class='modula2-Symbol def-Symbol'>IF</span> Str<span class='modula2-Number def-Number'>.</span>Compare<span class='modula2-Symbol def-Symbol'>(</span> Name<span class='modula2-Symbol def-Symbol'>,</span> name <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
203:           Overlay <span class='modula2-Symbol def-Symbol'>:=</span> ovln<span class='modula2-Symbol def-Symbol'>;</span>
204:           <span class='modula2-Keyword def-Keyword'>EXIT</span><span class='modula2-Symbol def-Symbol'>;</span>
205:         <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
206:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
207:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
208:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
209: <span class='modula2-Symbol def-Symbol'>END</span> ReadOvl<span class='modula2-Symbol def-Symbol'>;</span>
210: 
211: <span class='modula2-Keyword def-Keyword'>VAR</span> newseg_in_exe<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>BOOLEAN</span><span class='modula2-Symbol def-Symbol'>;</span>
212: 
213: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> newseg<span class='modula2-Symbol def-Symbol'>(</span> seg<span class='modula2-Symbol def-Symbol'>,</span>off<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
214: <span class='modula2-Keyword def-Keyword'>VAR</span> loc<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
215:     k<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
216: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
217:   loc <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>*</span>VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>seg<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>+</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>off<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
218:   k <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>;</span>
219:   <span class='modula2-Comment def-Comment def-Syntax'>(* search for location segment = k *)</span>
220:   <span class='modula2-Symbol def-Symbol'>WHILE</span> <span class='modula2-Symbol def-Symbol'>(</span> k <span class='modula2-Symbol def-Symbol'>&lt;=</span> nmap <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> loc <span class='modula2-Symbol def-Symbol'>>=</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Start <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DO</span> INC<span class='modula2-Symbol def-Symbol'>(</span>k<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
221:   DEC<span class='modula2-Symbol def-Symbol'>(</span>k<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
222:   newseg_in_exe <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Symbol def-Symbol'>(</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
223:   <span class='modula2-Keyword def-Keyword'>RETURN</span> seg <span class='modula2-Symbol def-Symbol'>-</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Diff<span class='modula2-Symbol def-Symbol'>;</span>
224: <span class='modula2-Symbol def-Symbol'>END</span> newseg<span class='modula2-Symbol def-Symbol'>;</span>
225: 
226: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> hex<span class='modula2-Symbol def-Symbol'>(</span>n<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
227: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
228:   n <span class='modula2-Symbol def-Symbol'>:=</span> n <span class='modula2-Keyword def-Keyword'>MOD</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
229:   <span class='modula2-Symbol def-Symbol'>IF</span> n <span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>9</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
230:     <span class='modula2-Keyword def-Keyword'>RETURN</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span> n <span class='modula2-Symbol def-Symbol'>+</span> ORD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'A'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>-</span> <span class='modula2-Number def-Number'>10</span> <span class='modula2-Symbol def-Symbol'>)</span>
231:   <span class='modula2-Keyword def-Keyword'>ELSE</span>
232:     <span class='modula2-Keyword def-Keyword'>RETURN</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span> n <span class='modula2-Symbol def-Symbol'>+</span> ORD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
233:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
234: <span class='modula2-Symbol def-Symbol'>END</span> hex<span class='modula2-Symbol def-Symbol'>;</span>
235: 
236: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> EditMap<span class='modula2-Symbol def-Symbol'>;</span>
237: <span class='modula2-Keyword def-Keyword'>VAR</span> line<span class='modula2-Symbol def-Symbol'>:</span>String<span class='modula2-Symbol def-Symbol'>;</span>
238:     i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
239:     seg<span class='modula2-Symbol def-Symbol'>,</span>off<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
240:     addr<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
241: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
242:   FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span>mapfile<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
243:   <span class='modula2-Symbol def-Symbol'>LOOP</span>
244:     FIO<span class='modula2-Number def-Number'>.</span>RdStr<span class='modula2-Symbol def-Symbol'>(</span>mapfile<span class='modula2-Symbol def-Symbol'>,</span>line<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
245:     newseg_in_exe <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-Constant def-Keyword'>TRUE</span><span class='modula2-Symbol def-Symbol'>;</span>
246:     <span class='modula2-Symbol def-Symbol'>IF</span> FIO<span class='modula2-Number def-Number'>.</span>EOF <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>EXIT</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
247:     <span class='modula2-Symbol def-Symbol'>IF</span> <span class='modula2-Symbol def-Symbol'>(</span> line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>5</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>':'</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
248:       seg <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>ReadHex<span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
249:       off <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>ReadHex<span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>6</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
250:       seg <span class='modula2-Symbol def-Symbol'>:=</span> newseg<span class='modula2-Symbol def-Symbol'>(</span> seg<span class='modula2-Symbol def-Symbol'>,</span> off <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
251:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>4</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
252:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>3</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
253:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>2</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
254:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
255:     <span class='modula2-Keyword def-Keyword'>ELSIF</span> <span class='modula2-Symbol def-Symbol'>(</span> line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>' '</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>6</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-String def-String'>'H'</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
256:       addr <span class='modula2-Symbol def-Symbol'>:=</span> ReadHex<span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
257:       seg <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>addr <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
258:       off <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>addr<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>MOD</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
259:       seg <span class='modula2-Symbol def-Symbol'>:=</span> newseg<span class='modula2-Symbol def-Symbol'>(</span> seg<span class='modula2-Symbol def-Symbol'>,</span> off <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
260:       addr <span class='modula2-Symbol def-Symbol'>:=</span> LONGCARD<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>+</span> LONGCARD<span class='modula2-Symbol def-Symbol'>(</span>off<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>+</span> ReadHex<span class='modula2-Symbol def-Symbol'>(</span>line<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>15</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
261:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>4</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
262:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>3</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
263:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>2</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
264:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
265:       seg <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>addr <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
266:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>11</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
267:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>10</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
268:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>9</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
269:       line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>8</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> hex<span class='modula2-Symbol def-Symbol'>(</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> seg <span class='modula2-Symbol def-Symbol'>:=</span> seg <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
270:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
271: <span class='modula2-Comment def-Comment def-Syntax'>(*    IF NOT newseg_in_exe THEN</span>
272: <span class='modula2-Comment def-Comment def-Syntax'>      IO.WrStr(line);</span>
273: <span class='modula2-Comment def-Comment def-Syntax'>      IO.WrLn;</span>
274: <span class='modula2-Comment def-Comment def-Syntax'>      END;</span>
275: <span class='modula2-Comment def-Comment def-Syntax'>*)</span>
276:     <span class='modula2-Symbol def-Symbol'>IF</span> newseg_in_exe <span class='modula2-Keyword def-Keyword'>THEN</span>
277:       <span class='modula2-Symbol def-Symbol'>IF</span> line<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
278:         FIO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span>newmapfile<span class='modula2-Symbol def-Symbol'>,</span>line<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
279:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
280:       FIO<span class='modula2-Number def-Number'>.</span>WrLn<span class='modula2-Symbol def-Symbol'>(</span>newmapfile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
281:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
282:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
283: <span class='modula2-Symbol def-Symbol'>END</span> EditMap<span class='modula2-Symbol def-Symbol'>;</span>
284: 
285: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> PrintMap<span class='modula2-Symbol def-Symbol'>;</span>
286: <span class='modula2-Keyword def-Keyword'>VAR</span> i<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
287: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
288:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>TO</span> nmap <span class='modula2-Keyword def-Keyword'>DO</span>
289:     <span class='modula2-Symbol def-Symbol'>WITH</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
290:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>' Start='</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>  IO<span class='modula2-Number def-Number'>.</span>WrLngCard<span class='modula2-Symbol def-Symbol'>(</span>Start<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>6</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
291:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>' Diff='</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> IO<span class='modula2-Number def-Number'>.</span>WrCard<span class='modula2-Symbol def-Symbol'>(</span>Diff<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>5</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
292:       IO<span class='modula2-Number def-Number'>.</span>WrCard<span class='modula2-Symbol def-Symbol'>(</span>Overlay<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>3</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
293:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>' '</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
294:       IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span>Name<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
295:       IO<span class='modula2-Number def-Number'>.</span>WrLn<span class='modula2-Symbol def-Symbol'>;</span>
296:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
297:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
298: <span class='modula2-Symbol def-Symbol'>END</span> PrintMap<span class='modula2-Symbol def-Symbol'>;</span>
299: 
300: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> ChkRead<span class='modula2-Symbol def-Symbol'>(</span> <span class='modula2-Keyword def-Keyword'>VAR</span> buf<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>BYTE</span><span class='modula2-Symbol def-Symbol'>;</span> count<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
301: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
302:   <span class='modula2-Symbol def-Symbol'>IF</span> FIO<span class='modula2-Number def-Number'>.</span>RdBin<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> buf<span class='modula2-Symbol def-Symbol'>,</span> count <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> count <span class='modula2-Keyword def-Keyword'>THEN</span>
303:     IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'?? on read'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
304:     HALT<span class='modula2-Symbol def-Symbol'>;</span>
305:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
306: <span class='modula2-Symbol def-Symbol'>END</span> ChkRead<span class='modula2-Symbol def-Symbol'>;</span>
307: 
308: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> ChkRead1<span class='modula2-Symbol def-Symbol'>(</span> <span class='modula2-Keyword def-Keyword'>VAR</span> buf<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>BYTE</span><span class='modula2-Symbol def-Symbol'>;</span> count<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
309: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
310:   <span class='modula2-Symbol def-Symbol'>IF</span> FIO<span class='modula2-Number def-Number'>.</span>RdBin<span class='modula2-Symbol def-Symbol'>(</span> exefile1<span class='modula2-Symbol def-Symbol'>,</span> buf<span class='modula2-Symbol def-Symbol'>,</span> count <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> count <span class='modula2-Keyword def-Keyword'>THEN</span>
311:     IO<span class='modula2-Number def-Number'>.</span>WrStr<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'?? on read'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
312:     HALT<span class='modula2-Symbol def-Symbol'>;</span>
313:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
314: <span class='modula2-Symbol def-Symbol'>END</span> ChkRead1<span class='modula2-Symbol def-Symbol'>;</span>
315: 
316: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> Copy<span class='modula2-Symbol def-Symbol'>(</span>src<span class='modula2-Symbol def-Symbol'>,</span>dst<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> count<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
317: <span class='modula2-Keyword def-Keyword'>VAR</span> amount<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> actual<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
318:     buf<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span> <span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..</span><span class='modula2-Number def-Number'>0FFFH</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>;</span>
319:     res<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
320: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
321:   res <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
322:   <span class='modula2-Symbol def-Symbol'>WHILE</span> count <span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>DO</span>
323:     amount <span class='modula2-Symbol def-Symbol'>:=</span> count<span class='modula2-Symbol def-Symbol'>;</span>
324:     <span class='modula2-Symbol def-Symbol'>IF</span> amount <span class='modula2-Symbol def-Symbol'>></span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>buf<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
325:       amount <span class='modula2-Symbol def-Symbol'>:=</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>buf<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
326:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
327:     actual <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>RdBin<span class='modula2-Symbol def-Symbol'>(</span> src<span class='modula2-Symbol def-Symbol'>,</span> buf<span class='modula2-Symbol def-Symbol'>,</span> amount <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
328:     <span class='modula2-Symbol def-Symbol'>IF</span> actual <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
329:       FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> dst<span class='modula2-Symbol def-Symbol'>,</span> buf<span class='modula2-Symbol def-Symbol'>,</span> actual <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
330:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
331:     DEC<span class='modula2-Symbol def-Symbol'>(</span>count<span class='modula2-Symbol def-Symbol'>,</span>amount<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
332:     INC<span class='modula2-Symbol def-Symbol'>(</span>res<span class='modula2-Symbol def-Symbol'>,</span>actual<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
333:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
334:   <span class='modula2-Keyword def-Keyword'>RETURN</span> res<span class='modula2-Symbol def-Symbol'>;</span>
335: <span class='modula2-Symbol def-Symbol'>END</span> Copy<span class='modula2-Symbol def-Symbol'>;</span>
336: 
337: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> LongCopy<span class='modula2-Symbol def-Symbol'>(</span>src<span class='modula2-Symbol def-Symbol'>,</span>dst<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> count<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
338: <span class='modula2-Keyword def-Keyword'>VAR</span> junk<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
339: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
340:   <span class='modula2-Symbol def-Symbol'>WHILE</span> count <span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>8000H</span> <span class='modula2-Keyword def-Keyword'>DO</span>
341:     junk <span class='modula2-Symbol def-Symbol'>:=</span> Copy<span class='modula2-Symbol def-Symbol'>(</span>src<span class='modula2-Symbol def-Symbol'>,</span>dst<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>8000H</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
342:     DEC<span class='modula2-Symbol def-Symbol'>(</span>count<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>8000H</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
343:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
344:   junk <span class='modula2-Symbol def-Symbol'>:=</span> Copy<span class='modula2-Symbol def-Symbol'>(</span> src<span class='modula2-Symbol def-Symbol'>,</span>dst<span class='modula2-Symbol def-Symbol'>,</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>count<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
345: <span class='modula2-Symbol def-Symbol'>END</span> LongCopy<span class='modula2-Symbol def-Symbol'>;</span>
346: 
347: 
348: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> resetexe<span class='modula2-Symbol def-Symbol'>;</span>
349: <span class='modula2-Keyword def-Keyword'>VAR</span> filename<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..255</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
350: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
351:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.exe'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
352:   exefile <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Create<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
353: <span class='modula2-Symbol def-Symbol'>END</span> resetexe<span class='modula2-Symbol def-Symbol'>;</span>
354: 
355: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> MakeFix<span class='modula2-Symbol def-Symbol'>(</span> k<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> loc<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span> j<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> target<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span> internalfix<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>BOOLEAN</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
356: <span class='modula2-Keyword def-Keyword'>VAR</span>
357:    tmp<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
358:    fix<span class='modula2-Symbol def-Symbol'>:</span>tfix<span class='modula2-Symbol def-Symbol'>;</span>
359: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
360:   <span class='modula2-Comment def-Comment def-Syntax'>(*</span>
361: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr('k='); IO.WrCard(k,1);</span>
362: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr('j='); IO.WrCard(j,1);</span>
363: <span class='modula2-Comment def-Comment def-Syntax'></span>
364: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr( ' map[k].Overlay=' ); IO.WrCard( ORD(map[k].Overlay),1 );</span>
365: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr( ' map[j].Overlay=' ); IO.WrCard( ORD(map[j].Overlay),1 );</span>
366: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr( ' loc=' ); IO.WrLngCard( loc, 1 );</span>
367: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr( ' target=' ); IO.WrCard( target, 1 );</span>
368: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrLn;</span>
369: <span class='modula2-Comment def-Comment def-Syntax'>  *)</span>
370:   <span class='modula2-Symbol def-Symbol'>IF</span> internalfix <span class='modula2-Keyword def-Keyword'>THEN</span>
371:     <span class='modula2-Symbol def-Symbol'>IF</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
372:       <span class='modula2-Symbol def-Symbol'>IF</span> map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
373:         <span class='modula2-Keyword def-Keyword'>RETURN</span><span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* overlay 0 requires only internal fixups to itself *)</span>
374:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
375:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
376:     INC<span class='modula2-Symbol def-Symbol'>(</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>nifix <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
377:     tmp <span class='modula2-Symbol def-Symbol'>:=</span> j<span class='modula2-Symbol def-Symbol'>;</span> j <span class='modula2-Symbol def-Symbol'>:=</span> k<span class='modula2-Symbol def-Symbol'>;</span> k <span class='modula2-Symbol def-Symbol'>:=</span> tmp<span class='modula2-Symbol def-Symbol'>;</span>
378:   <span class='modula2-Keyword def-Keyword'>ELSE</span>
379:     <span class='modula2-Symbol def-Symbol'>IF</span> map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>RETURN</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
380:     <span class='modula2-Symbol def-Symbol'>IF</span> map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>=</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Keyword def-Keyword'>THEN</span> <span class='modula2-Keyword def-Keyword'>RETURN</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
381:     INC<span class='modula2-Symbol def-Symbol'>(</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>nefix <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
382:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
383: 
384:   fix<span class='modula2-Number def-Number'>.</span>locoff <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Symbol def-Symbol'>(</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>(</span>loc<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>MOD</span> <span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>+</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>*</span>SHORTCARD<span class='modula2-Symbol def-Symbol'>(</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
385:   fix<span class='modula2-Number def-Number'>.</span>locseg <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>loc <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
386:   fix<span class='modula2-Number def-Number'>.</span>target <span class='modula2-Symbol def-Symbol'>:=</span> target<span class='modula2-Symbol def-Symbol'>;</span>
387:   FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>,</span> fix<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>fix<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
388: 
389: <span class='modula2-Symbol def-Symbol'>END</span> MakeFix<span class='modula2-Symbol def-Symbol'>;</span>
390: 
391: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> Main<span class='modula2-Symbol def-Symbol'>;</span>
392: <span class='modula2-Keyword def-Keyword'>VAR</span>
393:   exe<span class='modula2-Symbol def-Symbol'>:</span>texeheader<span class='modula2-Symbol def-Symbol'>;</span>
394:   dummy<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
395:   i<span class='modula2-Symbol def-Symbol'>,</span>j<span class='modula2-Symbol def-Symbol'>,</span>k<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
396:   hsize<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
397:   filename<span class='modula2-Symbol def-Symbol'>:</span>String<span class='modula2-Symbol def-Symbol'>;</span>
398:   ext<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..3</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
399:   pad<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..15</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> SHORTCARD<span class='modula2-Symbol def-Symbol'>;</span>
400:   padsize<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
401:   copysize<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
402:   target<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
403:   internalfix<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>BOOLEAN</span><span class='modula2-Symbol def-Symbol'>;</span>
404:   fixlocabs<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
405:   fsize<span class='modula2-Symbol def-Symbol'>:</span>LONGCARD<span class='modula2-Symbol def-Symbol'>;</span>
406:   hpage<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
407:   fix<span class='modula2-Symbol def-Symbol'>:</span>tfix<span class='modula2-Symbol def-Symbol'>;</span>
408:   exefix<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Symbol def-Symbol'>RECORD</span> off<span class='modula2-Symbol def-Symbol'>,</span>seg<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
409:   file<span class='modula2-Symbol def-Symbol'>:</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>;</span>
410: 
411: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
412:   ChkRead<span class='modula2-Symbol def-Symbol'>(</span> exe<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>exe<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
413:   hsize <span class='modula2-Symbol def-Symbol'>:=</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>exe<span class='modula2-Number def-Number'>.</span>headerparas<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
414: 
415:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>TO</span> MaxOverlay <span class='modula2-Keyword def-Keyword'>DO</span>
416:     ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
417:     <span class='modula2-Symbol def-Symbol'>WITH</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
418:       Alloc <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
419:       Init <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
420:       nifix <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
421:       nefix <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
422:       copyr <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-String def-String'>'JPI'</span> <span class='modula2-Symbol def-Symbol'>;</span>
423:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
424:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
425: 
426:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>TO</span> <span class='modula2-Number def-Number'>15</span> <span class='modula2-Keyword def-Keyword'>DO</span> pad<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
427: 
428:   <span class='modula2-Comment def-Comment def-Syntax'>(* Now read through exe file redistributing segments *)</span>
429:   FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> hsize <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
430:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>TO</span> nmap <span class='modula2-Keyword def-Keyword'>DO</span>
431:     <span class='modula2-Symbol def-Symbol'>WITH</span> map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
432:       <span class='modula2-Symbol def-Symbol'>WITH</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
433:         file <span class='modula2-Symbol def-Symbol'>:=</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>;</span>
434:         <span class='modula2-Symbol def-Symbol'>IF</span> file <span class='modula2-Symbol def-Symbol'>=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
435:            ext <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-String def-String'>'.ov '</span><span class='modula2-Symbol def-Symbol'>;</span>
436:            ext<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>3</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>(</span> Overlay<span class='modula2-Symbol def-Symbol'>+</span>ORD<span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-String def-String'>'0'</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
437:            Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> ext <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
438:            file <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Create<span class='modula2-Symbol def-Symbol'>(</span> filename <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
439:            ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>Overlay<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>:=</span> file<span class='modula2-Symbol def-Symbol'>;</span>
440:            FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> pad<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
441:          <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
442:         padsize <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Symbol def-Symbol'>(</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>Start<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>-</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>Alloc<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>MOD</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>;</span>
443:         FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> pad<span class='modula2-Symbol def-Symbol'>,</span> padsize <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
444:         INC<span class='modula2-Symbol def-Symbol'>(</span> Init<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span> padsize<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
445:         INC<span class='modula2-Symbol def-Symbol'>(</span> Alloc<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>padsize<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
446:         Diff <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>Start <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>-</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>Alloc <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
447:         copysize <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>map<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Start<span class='modula2-Symbol def-Symbol'>-</span>Start<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
448:         INC<span class='modula2-Symbol def-Symbol'>(</span> Init<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span> Copy<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> file<span class='modula2-Symbol def-Symbol'>,</span> copysize <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
449:         INC<span class='modula2-Symbol def-Symbol'>(</span> Alloc <span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>copysize<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
450:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
451:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
452:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
453: 
454:   <span class='modula2-Comment def-Comment def-Syntax'>(* OK. We now have the overlay files, so work out the fixups *)</span>
455: 
456: 
457:   <span class='modula2-Comment def-Comment def-Syntax'>(* First allocate buffers for overlays *)</span>
458:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>TO</span> MaxOverlay <span class='modula2-Keyword def-Keyword'>DO</span>
459:     <span class='modula2-Symbol def-Symbol'>IF</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
460:       GiveBuf<span class='modula2-Symbol def-Symbol'>(</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
461:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
462:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
463: 
464:   <span class='modula2-Symbol def-Symbol'>FOR</span> internalfix <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-Constant def-Keyword'>FALSE</span> <span class='modula2-Keyword def-Keyword'>TO</span> <span class='def-Constant def-Keyword'>TRUE</span> <span class='modula2-Keyword def-Keyword'>DO</span>
465:     FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile1<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>exe<span class='modula2-Number def-Number'>.</span>relocations<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
466:     <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>TO</span> exe<span class='modula2-Number def-Number'>.</span>numrelocitem <span class='modula2-Keyword def-Keyword'>DO</span>
467:       ChkRead1<span class='modula2-Symbol def-Symbol'>(</span> exefix<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>exefix<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
468:       fixlocabs <span class='modula2-Symbol def-Symbol'>:=</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>exefix<span class='modula2-Number def-Number'>.</span>off<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>*</span>VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>exefix<span class='modula2-Number def-Number'>.</span>seg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
469:       FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> hsize<span class='modula2-Symbol def-Symbol'>+</span>fixlocabs<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
470:       ChkRead<span class='modula2-Symbol def-Symbol'>(</span> target<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>target<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
471: 
472:       k <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>;</span>
473:       <span class='modula2-Comment def-Comment def-Syntax'>(* search for location segment = k *)</span>
474:       <span class='modula2-Symbol def-Symbol'>WHILE</span> <span class='modula2-Symbol def-Symbol'>(</span> k <span class='modula2-Symbol def-Symbol'>&lt;=</span> nmap <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>AND</span> <span class='modula2-Symbol def-Symbol'>(</span> fixlocabs <span class='modula2-Symbol def-Symbol'>>=</span> map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Start <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DO</span> INC<span class='modula2-Symbol def-Symbol'>(</span>k<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
475:       DEC<span class='modula2-Symbol def-Symbol'>(</span>k<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
476: 
477:   <span class='modula2-Comment def-Comment def-Syntax'>(*</span>
478: <span class='modula2-Comment def-Comment def-Syntax'>          IO.WrCard(target,1);</span>
479: <span class='modula2-Comment def-Comment def-Syntax'>          IO.WrStr(' at ');</span>
480: <span class='modula2-Comment def-Comment def-Syntax'>          IO.WrLngCard(fixlocabs,1);</span>
481: <span class='modula2-Comment def-Comment def-Syntax'>          IO.WrLn;</span>
482: <span class='modula2-Comment def-Comment def-Syntax'>  *)</span>
483: 
484:       j <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>;</span>
485:       <span class='modula2-Symbol def-Symbol'>LOOP</span> <span class='modula2-Comment def-Comment def-Syntax'>(* search for target segment = j *)</span>
486:         INC<span class='modula2-Symbol def-Symbol'>(</span>j<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
487:         <span class='modula2-Symbol def-Symbol'>IF</span> <span class='modula2-Symbol def-Symbol'>(</span> j <span class='modula2-Symbol def-Symbol'>></span> nmap <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>OR</span> <span class='modula2-Symbol def-Symbol'>(</span> target <span class='modula2-Symbol def-Symbol'>&lt;</span> map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>StartSeg <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
488:           DEC<span class='modula2-Symbol def-Symbol'>(</span>j<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
489:           MakeFix<span class='modula2-Symbol def-Symbol'>(</span> k<span class='modula2-Symbol def-Symbol'>,</span> fixlocabs <span class='modula2-Symbol def-Symbol'>-</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>map<span class='modula2-Symbol def-Symbol'>[</span>k<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Diff<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>,</span>
490:                    j<span class='modula2-Symbol def-Symbol'>,</span> target <span class='modula2-Symbol def-Symbol'>-</span> map<span class='modula2-Symbol def-Symbol'>[</span>j<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Diff<span class='modula2-Symbol def-Symbol'>,</span> internalfix <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
491:           <span class='modula2-Keyword def-Keyword'>EXIT</span><span class='modula2-Symbol def-Symbol'>;</span>
492:         <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
493:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
494:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
495:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
496: 
497:   <span class='modula2-Comment def-Comment def-Syntax'>(* Phew ! *)</span>
498:   <span class='modula2-Comment def-Comment def-Syntax'>(* Now save the headers *)</span>
499: 
500:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>TO</span> MaxOverlay <span class='modula2-Keyword def-Keyword'>DO</span>
501:     <span class='modula2-Symbol def-Symbol'>WITH</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>DO</span>
502:       file <span class='modula2-Symbol def-Symbol'>:=</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>;</span>
503:       <span class='modula2-Symbol def-Symbol'>IF</span> file <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
504:         FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
505:         FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
506:       <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
507:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
508:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
509: 
510: 
511:   <span class='modula2-Comment def-Comment def-Syntax'>(* Now rewrite exe file *)</span>
512: 
513:   resetexe<span class='modula2-Symbol def-Symbol'>;</span>
514:   hpage <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Symbol def-Symbol'>(</span> <span class='modula2-Number def-Number'>4</span><span class='modula2-Symbol def-Symbol'>*</span>ovlheaders<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>nifix <span class='modula2-Symbol def-Symbol'>+</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>texeheader<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>+</span> <span class='modula2-Number def-Number'>511</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>512</span><span class='modula2-Symbol def-Symbol'>;</span>
515:   hsize <span class='modula2-Symbol def-Symbol'>:=</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>hpage <span class='modula2-Symbol def-Symbol'>*</span> <span class='modula2-Number def-Number'>512</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
516: 
517:   FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>512</span><span class='modula2-Symbol def-Symbol'>*</span>hpage<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
518:   file <span class='modula2-Symbol def-Symbol'>:=</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>;</span>
519:   FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>16</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
520:   LongCopy<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>Init <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
521: 
522:   FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
523: 
524:   exe<span class='modula2-Number def-Number'>.</span>numrelocitem <span class='modula2-Symbol def-Symbol'>:=</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>nifix<span class='modula2-Symbol def-Symbol'>;</span>
525:   exe<span class='modula2-Number def-Number'>.</span>headerparas <span class='modula2-Symbol def-Symbol'>:=</span> hpage<span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>32</span><span class='modula2-Symbol def-Symbol'>;</span>
526:   exe<span class='modula2-Number def-Number'>.</span>relocations <span class='modula2-Symbol def-Symbol'>:=</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>texeheader<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
527:   exe<span class='modula2-Number def-Number'>.</span>initialcs <span class='modula2-Symbol def-Symbol'>:=</span> newseg<span class='modula2-Symbol def-Symbol'>(</span>exe<span class='modula2-Number def-Number'>.</span>initialcs<span class='modula2-Symbol def-Symbol'>,</span>exe<span class='modula2-Number def-Number'>.</span>initialip<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
528:   exe<span class='modula2-Number def-Number'>.</span>initialss <span class='modula2-Symbol def-Symbol'>:=</span> newseg<span class='modula2-Symbol def-Symbol'>(</span>exe<span class='modula2-Number def-Number'>.</span>initialss<span class='modula2-Symbol def-Symbol'>,</span><span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
529:   fsize <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Size<span class='modula2-Symbol def-Symbol'>(</span>exefile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
530:   exe<span class='modula2-Number def-Number'>.</span>sizemod512 <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span>fsize<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>MOD</span> <span class='modula2-Number def-Number'>512</span><span class='modula2-Symbol def-Symbol'>;</span>
531:   exe<span class='modula2-Number def-Number'>.</span>sizediv512 <span class='modula2-Symbol def-Symbol'>:=</span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>(</span>fsize<span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>511</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>DIV</span> <span class='modula2-Number def-Number'>512</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
532: 
533:   FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> exe<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>texeheader<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
534:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>1</span> <span class='modula2-Keyword def-Keyword'>TO</span> ovlheaders<span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0</span><span class='modula2-Symbol def-Symbol'>]</span><span class='modula2-Symbol def-Symbol'>.</span>nifix <span class='modula2-Keyword def-Keyword'>DO</span>
535:     dummy <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>RdBin<span class='modula2-Symbol def-Symbol'>(</span> file<span class='modula2-Symbol def-Symbol'>,</span> fix<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>fix<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
536:     fixlocabs <span class='modula2-Symbol def-Symbol'>:=</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>fix<span class='modula2-Number def-Number'>.</span>locoff<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>+</span><span class='modula2-Number def-Number'>16</span><span class='modula2-Symbol def-Symbol'>*</span>VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span>fix<span class='modula2-Number def-Number'>.</span>locseg<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
537: 
538: 
539:     FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> hsize<span class='modula2-Symbol def-Symbol'>+</span>fixlocabs<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
540:     FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> fix<span class='modula2-Number def-Number'>.</span>target<span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-Number def-Number'>2</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
541:   <span class='modula2-Comment def-Comment def-Syntax'>(*</span>
542: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr('Repatch at');</span>
543: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrLngCard( hsize+fixlocabs,1 );</span>
544: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrStr(' value ');</span>
545: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrCard( </span><span class='def-TODO def-Error'>fix.target, 1 );</span><span class='modula2-Comment def-Comment def-Syntax'></span>
546: <span class='modula2-Comment def-Comment def-Syntax'>  IO.WrLn;</span>
547: <span class='modula2-Comment def-Comment def-Syntax'>  *)</span>
548:     FIO<span class='modula2-Number def-Number'>.</span>Seek<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> VAL<span class='modula2-Symbol def-Symbol'>(</span>LONGCARD<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>texeheader<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>+</span> <span class='modula2-Symbol def-Symbol'>(</span>i<span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>*</span><span class='modula2-Number def-Number'>4</span> <span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
549:     exefix<span class='modula2-Number def-Number'>.</span>off <span class='modula2-Symbol def-Symbol'>:=</span> VAL<span class='modula2-Symbol def-Symbol'>(</span><span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>,</span>fix<span class='modula2-Number def-Number'>.</span>locoff<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
550:     exefix<span class='modula2-Number def-Number'>.</span>seg <span class='modula2-Symbol def-Symbol'>:=</span> fix<span class='modula2-Number def-Number'>.</span>locseg<span class='modula2-Symbol def-Symbol'>;</span>
551:     FIO<span class='modula2-Number def-Number'>.</span>WrBin<span class='modula2-Symbol def-Symbol'>(</span> exefile<span class='modula2-Symbol def-Symbol'>,</span> exefix<span class='modula2-Symbol def-Symbol'>,</span> SIZE<span class='modula2-Symbol def-Symbol'>(</span>exefix<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
552:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
553: 
554:   <span class='modula2-Comment def-Comment def-Syntax'>(* close buffered ovl files *)</span>
555:   <span class='modula2-Symbol def-Symbol'>FOR</span> i <span class='modula2-Symbol def-Symbol'>:=</span> <span class='modula2-Number def-Number'>0</span> <span class='modula2-Keyword def-Keyword'>TO</span> MaxOverlay <span class='modula2-Keyword def-Keyword'>DO</span>
556:     <span class='modula2-Symbol def-Symbol'>IF</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>&lt;</span><span class='modula2-Symbol def-Symbol'>></span> <span class='def-TypeKeyword def-Keyword'>CARDINAL</span><span class='modula2-Symbol def-Symbol'>(</span><span class='modula2-Symbol def-Symbol'>-</span><span class='modula2-Number def-Number'>1</span><span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Keyword def-Keyword'>THEN</span>
557:       FIO<span class='modula2-Number def-Number'>.</span>Close<span class='modula2-Symbol def-Symbol'>(</span> ovlfiles<span class='modula2-Symbol def-Symbol'>[</span>i<span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
558:     <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
559:   <span class='modula2-Symbol def-Symbol'>END</span><span class='modula2-Symbol def-Symbol'>;</span>
560: 
561: <span class='modula2-Symbol def-Symbol'>END</span> Main<span class='modula2-Symbol def-Symbol'>;</span>
562: 
563: <span class='modula2-Keyword def-Keyword'>VAR</span> filename<span class='modula2-Symbol def-Symbol'>:</span><span class='modula2-Keyword def-Keyword'>ARRAY</span><span class='modula2-Symbol def-Symbol'>[</span><span class='modula2-Number def-Number'>0..255</span><span class='modula2-Symbol def-Symbol'>]</span> <span class='modula2-Keyword def-Keyword'>OF</span> <span class='def-TypeKeyword def-Keyword'>CHAR</span><span class='modula2-Symbol def-Symbol'>;</span>
564: 
565: <span class='modula2-Keyword def-Keyword'>PROCEDURE</span> init<span class='modula2-Symbol def-Symbol'>;</span>
566: <span class='modula2-Keyword def-Keyword'>VAR</span>
567:   renname <span class='modula2-Symbol def-Symbol'>:</span> FIO<span class='modula2-Number def-Number'>.</span>PathStr <span class='modula2-Symbol def-Symbol'>;</span>
568: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
569:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.exe'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
570:   exefile <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Open<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> <span class='modula2-Comment def-Comment def-Syntax'>(* no buffering because random access *)</span>
571:   exefile1 <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Open<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> GiveBuf<span class='modula2-Symbol def-Symbol'>(</span>exefile1<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
572:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.ovl'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
573:   ovlfile <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Open<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> GiveBuf<span class='modula2-Symbol def-Symbol'>(</span>ovlfile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
574:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.map'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
575:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> renname<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.omp'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
576:   FIO<span class='modula2-Number def-Number'>.</span>Erase<span class='modula2-Symbol def-Symbol'>(</span>renname<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
577:   FIO<span class='modula2-Number def-Number'>.</span>Rename<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>,</span>renname<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
578:   mapfile <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Open<span class='modula2-Symbol def-Symbol'>(</span>renname<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> GiveBuf<span class='modula2-Symbol def-Symbol'>(</span>mapfile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
579:   newmapfile <span class='modula2-Symbol def-Symbol'>:=</span> FIO<span class='modula2-Number def-Number'>.</span>Create<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span> GiveBuf<span class='modula2-Symbol def-Symbol'>(</span>newmapfile<span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
580: <span class='modula2-Symbol def-Symbol'>END</span> init<span class='modula2-Symbol def-Symbol'>;</span>
581: 
582: <span class='modula2-Symbol def-Symbol'>BEGIN</span>
583:   init<span class='modula2-Symbol def-Symbol'>;</span>
584:   ReadMap<span class='modula2-Symbol def-Symbol'>;</span>
585:   ReadOvl<span class='modula2-Symbol def-Symbol'>;</span>
586:   too_small_check<span class='modula2-Symbol def-Symbol'>;</span>
587:   Main<span class='modula2-Symbol def-Symbol'>;</span>
588: <span class='modula2-Comment def-Comment def-Syntax'>(*  PrintMap; *)</span>
589:   EditMap<span class='modula2-Symbol def-Symbol'>;</span>
590:   Str<span class='modula2-Number def-Number'>.</span>Concat<span class='modula2-Symbol def-Symbol'>(</span> filename<span class='modula2-Symbol def-Symbol'>,</span> Lib<span class='modula2-Number def-Number'>.</span>CommandLine<span class='modula2-Symbol def-Symbol'>^</span><span class='modula2-Symbol def-Symbol'>,</span> <span class='modula2-String def-String'>'.ov0'</span><span class='modula2-Symbol def-Symbol'>)</span><span class='modula2-Symbol def-Symbol'>;</span>
591:   FIO<span class='modula2-Number def-Number'>.</span>Erase<span class='modula2-Symbol def-Symbol'>(</span>filename<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
592:   FIO<span class='modula2-Number def-Number'>.</span>Close<span class='modula2-Symbol def-Symbol'>(</span>newmapfile<span class='modula2-Symbol def-Symbol'>)</span> <span class='modula2-Symbol def-Symbol'>;</span>
593: <span class='modula2-Symbol def-Symbol'>END</span> ovl<span class='modula2-Symbol def-Symbol'>.</span>
594: 
595: 
596: 
